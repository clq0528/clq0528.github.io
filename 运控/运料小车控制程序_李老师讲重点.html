<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ–™å°è½¦ PLC å¾€å¤ä¸æŠ¥è­¦æ§åˆ¶ä»¿çœŸ (è§†è§‰å¢å¼ºç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #fff;
            --plc-color: #37474f;
            --wire-off: #cfd8dc;
            --wire-on: #ff5252; /* é€šç”µçº¢ */
            --logic-on: #00e676; /* é€»è¾‘ç»¿ */
            --highlight: #fff9c4;
            --alarm-color: #ffb300;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 10px; user-select: none;
        }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .container {
            display: grid;
            grid-template-columns: 1fr 480px; /* å·¦å®½å³çª„ */
            gap: 15px;
            width: 1200px;
            height: 800px;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            padding: 8px 15px; background: #eceff1; border-bottom: 1px solid #cfd8dc;
            font-weight: bold; color: #455a64; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- å·¦ä¾§ï¼šä»»åŠ¡ä¹¦ä¸åœºæ™¯ --- */
        
        /* 1. ä»»åŠ¡è¯´æ˜ä¹¦ (ä»¿çº¸å¼ ) */
        .task-paper {
            padding: 15px; background: #fffbf0; border-bottom: 1px solid #eee;
            font-size: 14px; color: #444; line-height: 1.6;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.02);
        }
        .task-title { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #333; }
        .highlight-text { color: #d32f2f; font-weight: bold; background: rgba(255,0,0,0.05); padding: 0 4px; border-radius: 2px;}

        /* 2. åœºæ™¯åŠ¨ç”»åŒº */
        .scene {
            flex: 1; position: relative; background: #fafafa; border-bottom: 1px solid #eee;
            overflow: hidden;
        }

        /* è½¨é“ */
        .track {
            position: absolute; top: 100px; left: 60px; right: 60px; height: 8px; background: #90a4ae; border-radius: 4px;
        }
        .track-mark {
            position: absolute; top: 115px; width: 2px; height: 10px; background: #cfd8dc;
        }

        /* ä¼ æ„Ÿå™¨ */
        .sensor {
            position: absolute; top: 110px; width: 12px; height: 18px; 
            background: #b0bec5; border: 1px solid #78909c; z-index: 5;
            transition: 0.1s;
        }
        .sensor::before {
            content: attr(data-id); position: absolute; top: -20px; left: -10px; width: 32px;
            text-align: center; font-size: 12px; font-weight: bold; color: #546e7a;
        }
        .sensor.active { background: #ff5252; box-shadow: 0 0 8px #ff5252; border-color: #b71c1c; }
        
        /* ä¼ æ„Ÿå™¨æ•…éšœæ¨¡æ‹Ÿæ ‡è®° */
        .sensor.broken { opacity: 0.5; border: 2px dashed red; background: repeating-linear-gradient(45deg, #eee, #eee 2px, #ccc 2px, #ccc 4px); }
        .sensor.broken::after { content: 'âŒ'; position: absolute; font-size: 10px; top: 2px; left: 0; }

        /* å°è½¦ */
        .cart {
            position: absolute; top: 65px; width: 70px; height: 45px;
            background: #1976d2; border-radius: 6px; border: 2px solid #0d47a1;
            z-index: 10; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 12px; box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            transition: left 0.05s linear; /* è¿™é‡Œçš„ transition æ—¶é—´ä¼šç”± JS åŠ¨æ€è°ƒæ•´ä»¥åŒ¹é…é€Ÿåº¦ */
        }
        .cart-wheel {
            position: absolute; bottom: -6px; width: 14px; height: 14px; background: #333; border-radius: 50%;
        }
        .w-left { left: 8px; } .w-right { right: 8px; }
        
        /* æŠ¥è­¦ç¯ */
        .alarm-light {
            position: absolute; top: 20px; width: 30px; height: 30px; border-radius: 50%;
            background: #5d4037; border: 2px solid #3e2723;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }
        .alarm-light.on {
            background: #ffb300; box-shadow: 0 0 20px #ffb300, inset 0 0 10px #fff;
            animation: flash 0.5s infinite alternate;
            color: #3e2723; font-weight: bold; border-color: #ff6f00;
        }
        @keyframes flash { from { opacity: 0.6; } to { opacity: 1; } }

        /* 3. æ§åˆ¶å° */
        .control-deck {
            height: 160px; padding: 10px 20px; background: #eceff1; display: flex; gap: 30px;
            align-items: center; border-top: 1px solid #cfd8dc;
        }

        .ctrl-group {
            display: flex; flex-direction: column; gap: 8px; align-items: center;
            background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #d0d0d0;
        }
        .ctrl-label { font-size: 12px; color: #78909c; font-weight: bold; }

        /* æŒ‰é’® */
        .btn {
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid #b0bec5;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #fff; box-shadow: 0 3px 0 #78909c; transition: all 0.1s;
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-green { background: #4caf50; }
        .btn-red { background: #f44336; }
        
        /* æ•…éšœå¤é€‰æ¡† */
        .check-row { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #333; cursor: pointer; }
        
        /* é€Ÿåº¦æ»‘å— */
        input[type=range] { width: 100px; cursor: pointer; }

        /* --- å³ä¾§ï¼šPLC é€»è¾‘ä¸æ—¥å¿— --- */
        .plc-status {
            padding: 8px; background: var(--plc-color); color: #cfd8dc; font-size: 12px;
            display: flex; gap: 10px; justify-content: center;
        }
        .io-dot {
            width: 10px; height: 10px; background: #546e7a; border-radius: 50%; display: inline-block; margin-right: 4px;
            transition: background 0.05s, box-shadow 0.05s; /* è½»å¾®è¿‡æ¸¡ */
        }
        .io-dot.on { background: #00e676; box-shadow: 0 0 5px #00e676; }

        /* æ¢¯å½¢å›¾ */
        .ladder-box {
            flex: 2; overflow-y: auto; background: #fff; padding: 10px;
            font-family: 'Consolas', monospace; position: relative;
        }
        .rung {
            position: relative; height: 75px; border-bottom: 1px dashed #eee; margin-bottom: 5px;
            display: flex; align-items: center; opacity: 0.8; transition: opacity 0.2s;
        }
        .rung.active-logic { opacity: 1; background: rgba(0, 230, 118, 0.05); }

        .rail { position: absolute; top:0; bottom:0; width: 4px; background: #333; }
        .rail.l { left: 0; } .rail.r { right: 0; }

        /* æ¢¯å½¢å›¾å…ƒä»¶ */
        .wire { height: 2px; background: #333; position: absolute; transition: background 0.1s; }
        .wire.on { background: var(--wire-on); height: 3px; z-index: 2; box-shadow: 0 0 4px var(--wire-on); }

        .symbol {
            position: absolute; top: 18px; width: 40px; text-align: center; font-size: 16px; font-weight: bold;
            background: #fff; z-index: 3; cursor: help;
        }
        .symbol-lbl { font-size: 10px; color: #1976d2; position: absolute; top: -14px; left: 0; width: 100%; text-align: center; }
        .symbol.on { color: var(--logic-on); text-shadow: 0 0 2px var(--logic-on); }

        /* å®æ—¶æ—¥å¿— */
        .log-panel {
            flex: 1; background: #263238; color: #eceff1; font-family: 'Consolas', monospace;
            padding: 10px; overflow-y: auto; font-size: 12px; border-top: 4px solid #37474f;
        }
        .log-entry { margin-bottom: 4px; padding-left: 10px; border-left: 2px solid transparent; }
        .log-info { border-left-color: #29b6f6; color: #81d4fa; }
        .log-warn { border-left-color: #ffca28; color: #fff59d; }
        .log-err { border-left-color: #ff5252; color: #ff8a80; }
        .log-cycle { color: #546e7a; font-size: 10px; margin-top: 2px; border: none; }

    </style>
</head>
<body>

<div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="panel">
        <div class="header">
            <span>ç³»ç»Ÿæ§åˆ¶å° (System Console)</span>
            <span style="font-size:12px; color:#78909c;">FX3U Series</span>
        </div>

        <!-- ä»»åŠ¡è¯´æ˜ -->
        <div class="task-paper">
            <div class="task-title">ğŸ“‘ è¿æ–™å°è½¦æ§åˆ¶ç¨‹åº (Task Requirements)</div>
            <div>1. <span class="highlight-text">å¯åŠ¨(X0)</span>ï¼šå°è½¦ä»ä¸­é—´ä½ç½®å‘å·¦è¡Œé©¶ã€‚</div>
            <div>2. <span class="highlight-text">å¾€å¤è¿è¡Œ</span>ï¼šç¢°å·¦é™ä½(X1)â†’å‘å³ï¼›ç¢°å³é™ä½(X2)â†’å‘å·¦ã€‚</div>
            <div>3. <span class="highlight-text">åœæ­¢(X5)</span>ï¼šæŒ‰ä¸‹æŒ‰é’®ï¼Œå°è½¦è¿è¡Œåˆ°ä¸­é—´ä½ç½®(X6)è‡ªåŠ¨åœæ­¢ã€‚</div>
            <div>4. <span class="highlight-text">æ•…éšœæŠ¥è­¦</span>ï¼šå·¦1å¤±çµç¢°å·¦2(X3)â†’æŠ¥è­¦(Y2)ï¼›å³1å¤±çµç¢°å³2(X4)â†’æŠ¥è­¦(Y3)ã€‚</div>
        </div>

        <!-- åœºæ™¯ -->
        <div class="scene">
            <!-- æŠ¥è­¦ç¯ -->
            <div class="alarm-light" id="lamp-y2" style="left: 20px;">Y2<br>å·¦è­¦</div>
            <div class="alarm-light" id="lamp-y3" style="right: 20px;">Y3<br>å³è­¦</div>

            <!-- è½¨é“ä¸ä¼ æ„Ÿå™¨ -->
            <div class="track"></div>
            
            <!-- ä¼ æ„Ÿå™¨ä½ç½® (0-100%) -->
            <!-- æé™/æŠ¥è­¦ä¼ æ„Ÿå™¨ -->
            <div class="sensor" id="sen-x3" style="left: 5%; height:22px; border-color:#e65100;" data-id="X3"></div>
            <div class="sensor" id="sen-x4" style="left: 95%; height:22px; border-color:#e65100;" data-id="X4"></div>

            <!-- æ­£å¸¸å·¥ä½œä¼ æ„Ÿå™¨ -->
            <div class="sensor" id="sen-x1" style="left: 15%;" data-id="X1"></div>
            <div class="sensor" id="sen-x6" style="left: 50%;" data-id="X6"></div>
            <div class="sensor" id="sen-x2" style="left: 85%;" data-id="X2"></div>

            <!-- å°è½¦ -->
            <div class="cart" id="cart" style="left: 50%;">
                <div class="cart-wheel w-left"></div>
                <span>CART</span>
                <div class="cart-wheel w-right"></div>
            </div>
            
            <div style="position: absolute; bottom: 5px; width: 100%; text-align: center; color: #aaa; font-size: 11px;">
                â—€â”€â”€â”€â”€ è¡Œç¨‹èŒƒå›´ â”€â”€â”€â”€â–¶
            </div>
        </div>

        <!-- æ“ä½œåŒº -->
        <div class="control-deck">
            <div class="ctrl-group">
                <div class="ctrl-label">æ“ä½œæŒ‰é’®</div>
                <div style="display:flex; gap:15px;">
                    <div style="text-align:center;">
                        <div class="btn btn-green" id="btn-x0" onmousedown="io.press('x0')" onmouseup="io.release('x0')">X0</div>
                        <span style="font-size:10px;">å¯åŠ¨</span>
                    </div>
                    <div style="text-align:center;">
                        <div class="btn btn-red" id="btn-x5" onmousedown="io.press('x5')" onmouseup="io.release('x5')">X5</div>
                        <span style="font-size:10px;">åœæ­¢</span>
                    </div>
                </div>
            </div>

            <div class="ctrl-group">
                <div class="ctrl-label">æ•…éšœæ¨¡æ‹Ÿ (Fault Sim)</div>
                <label class="check-row">
                    <input type="checkbox" id="fail-x1" onchange="sim.toggleFail('x1')"> å·¦é™ X1 å¤±çµ
                </label>
                <label class="check-row">
                    <input type="checkbox" id="fail-x2" onchange="sim.toggleFail('x2')"> å³é™ X2 å¤±çµ
                </label>
                <button onclick="sim.resetAlarm()" style="margin-top:5px; font-size:11px; cursor:pointer;">å¤ä½æŠ¥è­¦</button>
            </div>

            <div class="ctrl-group">
                <div class="ctrl-label">ç”µæœºé€Ÿåº¦ (Speed)</div>
                <input type="range" id="spd-slider" min="0.1" max="2.0" step="0.1" value="0.8">
                <span id="spd-val" style="font-size:10px; color:#555;">0.8x</span>
            </div>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ -->
    <div class="panel">
        <div class="header">PLC æ¢¯å½¢å›¾ç›‘æ§ (Ladder Monitor)</div>
        <div class="plc-status">
            <span>In:</span>
            <span class="io-dot" id="led-x0"></span>X0
            <span class="io-dot" id="led-x5"></span>X5
            <span class="io-dot" id="led-x1"></span>X1
            <span class="io-dot" id="led-x2"></span>X2
            <span class="io-dot" id="led-x6"></span>X6
            <span class="io-dot" id="led-x3"></span>X3
            <span>| Out:</span>
            <span class="io-dot" id="led-y0"></span>Y0
            <span class="io-dot" id="led-y1"></span>Y1
            <span class="io-dot" id="led-y2"></span>Y2
        </div>

        <div class="ladder-box" id="ladder">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ¢¯å½¢å›¾ç»“æ„ -->
            
            <!-- Rung 1: Start -->
            <div class="rung" id="rung-1">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w1-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x0" style="left:35px;"><div class="symbol-lbl">X0</div>| |</div>
                <div class="wire" id="w1-2" style="left:75px; width:180px; top:35px;"></div>
                <div class="symbol" id="coil-y0-set" style="left:260px;"><div class="symbol-lbl">Y0</div>(S)</div>
                <div class="wire" id="w1-3" style="left:300px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#999;">Start -> Left</span>
            </div>

            <!-- Rung 2: Hit Left Limit X1 -->
            <div class="rung" id="rung-2">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w2-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x1" style="left:35px;"><div class="symbol-lbl">X1</div>| |</div>
                <div class="wire" id="w2-2" style="left:75px; width:80px; top:35px;"></div>
                <div class="symbol" id="coil-y0-rst" style="left:160px;"><div class="symbol-lbl">Y0</div>(R)</div>
                <div class="wire" style="left:200px; width:30px; top:35px;"></div>
                <div class="symbol" id="coil-y1-set" style="left:240px;"><div class="symbol-lbl">Y1</div>(S)</div>
                <div class="wire" id="w2-3" style="left:280px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#999;">Limit L -> Right</span>
            </div>

             <!-- Rung 3: Hit Right Limit X2 -->
             <div class="rung" id="rung-3">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w3-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x2" style="left:35px;"><div class="symbol-lbl">X2</div>| |</div>
                <div class="wire" id="w3-2" style="left:75px; width:80px; top:35px;"></div>
                <div class="symbol" id="coil-y1-rst" style="left:160px;"><div class="symbol-lbl">Y1</div>(R)</div>
                <div class="wire" style="left:200px; width:30px; top:35px;"></div>
                <div class="symbol" id="coil-y0-set2" style="left:240px;"><div class="symbol-lbl">Y0</div>(S)</div>
                <div class="wire" id="w3-3" style="left:280px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#999;">Limit R -> Left</span>
            </div>

            <!-- Rung 4: Stop Request X5 -->
            <div class="rung" id="rung-4">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w4-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x5" style="left:35px;"><div class="symbol-lbl">X5</div>| |</div>
                <div class="wire" id="w4-2" style="left:75px; width:180px; top:35px;"></div>
                <div class="symbol" id="coil-m2" style="left:260px;"><div class="symbol-lbl">M2</div>(S)</div>
                <div class="wire" id="w4-3" style="left:300px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#999;">Stop Pressed -> Flag</span>
            </div>

            <!-- Rung 5: Stop Action (M2 + X6) -->
            <div class="rung" id="rung-5">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w5-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-m2" style="left:35px;"><div class="symbol-lbl">M2</div>| |</div>
                <div class="wire" id="w5-2" style="left:75px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x6" style="left:110px;"><div class="symbol-lbl">X6</div>| |</div>
                <div class="wire" id="w5-3" style="left:150px; width:30px; top:35px;"></div>
                <div class="symbol" id="coil-zrst" style="left:190px; width:60px;"><div class="symbol-lbl">ZRST</div>Y0 Y1</div>
                <div class="wire" style="left:255px; width:20px; top:35px;"></div>
                <div class="symbol" id="coil-m2-rst" style="left:280px;"><div class="symbol-lbl">M2</div>(R)</div>
                <div class="wire" id="w5-4" style="left:320px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#999;">Middle Stop</span>
            </div>

            <!-- Rung 6: Alarm Left (X3) -->
            <div class="rung" id="rung-6">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w6-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x3" style="left:35px;"><div class="symbol-lbl">X3</div>| |</div>
                <div class="wire" id="w6-2" style="left:75px; width:180px; top:35px;"></div>
                <div class="symbol" id="coil-y2" style="left:260px;"><div class="symbol-lbl">Y2</div>( )</div>
                <div class="wire" id="w6-3" style="left:300px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#d32f2f;">ALARM LEFT</span>
            </div>
            <!-- Rung 7: Alarm Right (X4) -->
            <div class="rung" id="rung-7">
                <div class="rail l"></div><div class="rail r"></div>
                <div class="wire" id="w7-1" style="left:5px; width:30px; top:35px;"></div>
                <div class="symbol" id="sym-x4" style="left:35px;"><div class="symbol-lbl">X4</div>| |</div>
                <div class="wire" id="w7-2" style="left:75px; width:180px; top:35px;"></div>
                <div class="symbol" id="coil-y3" style="left:260px;"><div class="symbol-lbl">Y3</div>( )</div>
                <div class="wire" id="w7-3" style="left:300px; right:5px; top:35px;"></div>
                <span style="position:absolute; right:10px; bottom:2px; font-size:10px; color:#d32f2f;">ALARM RIGHT</span>
            </div>

        </div>

        <div class="log-panel" id="log-console">
            <div class="log-entry log-info">ç³»ç»Ÿå·²åˆå§‹åŒ–ã€‚ç­‰å¾…å¯åŠ¨æŒ‡ä»¤...</div>
        </div>
    </div>
</div>

<script>
    // --- 1. ç³»ç»Ÿæ ¸å¿ƒæ•°æ® ---
    const sys = {
        scanCount: 0,
        running: true,
        failMode: { x1: false, x2: false },
        speed: 0.8
    };

    const plc = {
        in: { x0:0, x1:0, x2:0, x3:0, x4:0, x5:0, x6:0 }, // ç‰©ç†è¾“å…¥
        out: { y0:0, y1:0, y2:0, y3:0 }, // ç‰©ç†è¾“å‡º
        mem: { m2: 0 } // å†…éƒ¨è¾…åŠ©ç»§ç”µå™¨ M2 (åœæ­¢è¯·æ±‚)
    };

    const cart = {
        pos: 50.0, // 0 - 100%
        state: 'stop' // stop, left, right, alarm
    };

    // è§†è§‰çŠ¶æ€ä¿æŒï¼ˆç”¨äºå»¶é•¿ LED ç‚¹äº®æ—¶é—´ï¼‰
    const visualState = {
        ledTimers: {}, // è®°å½•æ¯ä¸ª LED ä¸Šæ¬¡å˜äº®çš„æ—¶é—´
        HOLD_TIME: 300 // æ¯«ç§’ï¼ŒLED æœ€å°‘ç‚¹äº®æ—¶é—´
    };

    // --- 2. äº¤äº’æ§åˆ¶ ---
    const io = {
        press: (id) => {
            plc.in[id] = 1;
            document.getElementById('btn-'+id).style.transform = "translateY(3px)";
            document.getElementById('btn-'+id).style.boxShadow = "none";
            logger.add(`[æ“ä½œ] æŒ‰ä¸‹æŒ‰é’® ${id.toUpperCase()}`, 'info');
        },
        release: (id) => {
            plc.in[id] = 0;
            document.getElementById('btn-'+id).style.transform = "translateY(0)";
            document.getElementById('btn-'+id).style.boxShadow = "0 3px 0 #78909c";
        }
    };

    const sim = {
        toggleFail: (id) => {
            sys.failMode[id] = document.getElementById('fail-'+id).checked;
            const el = document.getElementById('sen-'+id);
            if(sys.failMode[id]) {
                el.classList.add('broken');
                logger.add(`[æ•…éšœæ¨¡æ‹Ÿ] ä¼ æ„Ÿå™¨ ${id.toUpperCase()} å·²äººä¸ºå¤±æ•ˆ`, 'warn');
            } else {
                el.classList.remove('broken');
                logger.add(`[æ•…éšœæ¨¡æ‹Ÿ] ä¼ æ„Ÿå™¨ ${id.toUpperCase()} å·²æ¢å¤`, 'info');
            }
        },
        resetAlarm: () => {
            plc.out.y2 = 0;
            plc.out.y3 = 0;
            plc.out.y0 = 0;
            plc.out.y1 = 0;
            // ç®€å•é€»è¾‘ï¼šå¦‚æœæŠ¥è­¦æ¶ˆé™¤ï¼Œç¨å¾®æŠŠå°è½¦ç§»å‡ºå±é™©åŒºä»¥ä¾¿é‡å¯
            if(cart.pos < 10) cart.pos = 12;
            if(cart.pos > 90) cart.pos = 88;
            logger.add(`[ç³»ç»Ÿ] æŠ¥è­¦å¤ä½å®Œæˆï¼Œå°è½¦ä½ç½®é‡ç½®å®‰å…¨åŒº`, 'info');
        }
    };

    document.getElementById('spd-slider').addEventListener('input', (e) => {
        sys.speed = parseFloat(e.target.value);
        document.getElementById('spd-val').innerText = sys.speed + "x";
    });

    // --- 3. æ—¥å¿—ç³»ç»Ÿ ---
    const logger = {
        box: document.getElementById('log-console'),
        lastMsg: "",
        add: (msg, type='cycle') => {
            if(msg === logger.lastMsg && type === 'cycle') return; // é˜²æ­¢åˆ·å±
            
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString().split(' ')[0];
            if(type === 'cycle') {
                div.innerText = `Scan #${sys.scanCount}: ${msg}`;
            } else {
                div.innerText = `[${time}] ${msg}`;
            }
            logger.box.appendChild(div);
            logger.box.scrollTop = logger.box.scrollHeight;
            logger.lastMsg = msg;
        }
    };

    // --- 4. ä¸»å¾ªç¯ ---
    setInterval(() => {
        if(!sys.running) return;
        
        sys.scanCount++;
        physicsStep();
        plcScan();
        render();

    }, 30); // 33Hz åˆ·æ–°

    // --- ç‰©ç†å¼•æ“ ---
    function physicsStep() {
        // æŠ¥è­¦é”å®š
        if(plc.out.y2 || plc.out.y3) return;

        // è¿åŠ¨è®¡ç®—
        let moveStep = 0.5 * sys.speed;
        if(plc.out.y0) cart.pos -= moveStep;
        if(plc.out.y1) cart.pos += moveStep;

        // ç‰©ç†ç¢°æ’é™åˆ¶
        if(cart.pos < 0) cart.pos = 0;
        if(cart.pos > 100) cart.pos = 100;

        // ä¼ æ„Ÿå™¨é€»è¾‘ (Posæ˜ å°„)
        // X3 (Ultimate Left): < 5%
        plc.in.x3 = (cart.pos < 5) ? 1 : 0;
        
        // X1 (Normal Left): 12% - 18%
        // å¦‚æœæ•…éšœæ¨¡æ‹Ÿè¢«å‹¾é€‰ï¼ŒX1 æ°¸è¿œä¸º 0
        if (sys.failMode.x1) plc.in.x1 = 0;
        else plc.in.x1 = (cart.pos > 12 && cart.pos < 18) ? 1 : 0;

        // X6 (Middle): 48% - 52%
        plc.in.x6 = (cart.pos > 48 && cart.pos < 52) ? 1 : 0;

        // X2 (Normal Right): 82% - 88%
        if (sys.failMode.x2) plc.in.x2 = 0;
        else plc.in.x2 = (cart.pos > 82 && cart.pos < 88) ? 1 : 0;

        // X4 (Ultimate Right): > 95%
        plc.in.x4 = (cart.pos > 95) ? 1 : 0;
    }

    // --- PLC é€»è¾‘ (æ‰«æå‘¨æœŸ) ---
    function plcScan() {
        const prevY0 = plc.out.y0;
        const prevY1 = plc.out.y1;
        const prevY2 = plc.out.y2;
        const prevM2 = plc.mem.m2;

        // Rung 1: X0 (Start) -> SET Y0
        let r1_active = false;
        if(plc.in.x0) {
            // äº’é”: åªæœ‰ä¸åœ¨æŠ¥è­¦ä¸”ä¸è¿è¡Œå³æ—¶
            if(!plc.out.y2 && !plc.out.y3) {
                plc.out.y0 = 1; 
                plc.out.y1 = 0; 
                plc.mem.m2 = 0; // æ¸…é™¤åœæ­¢æ ‡è®°
                r1_active = true;
                if(!prevY0) logger.add("è§¦å‘å¯åŠ¨ X0 -> Y0 ç½®ä½ (å·¦è¡Œ)", "info");
            }
        }

        // Rung 2: Hit Left X1 -> RST Y0, SET Y1
        let r2_active = false;
        if(plc.in.x1 && plc.out.y0) {
            plc.out.y0 = 0;
            plc.out.y1 = 1;
            r2_active = true;
            logger.add("åˆ°è¾¾å·¦é™ä½ X1 -> åˆ‡æ¢æ–¹å‘ (Y1 å³è¡Œ)", "info");
        }

        // Rung 3: Hit Right X2 -> RST Y1, SET Y0
        let r3_active = false;
        if(plc.in.x2 && plc.out.y1) {
            plc.out.y1 = 0;
            plc.out.y0 = 1;
            r3_active = true;
            logger.add("åˆ°è¾¾å³é™ä½ X2 -> åˆ‡æ¢æ–¹å‘ (Y0 å·¦è¡Œ)", "info");
        }

        // Rung 4: Stop X5 -> SET M2
        let r4_active = false;
        if(plc.in.x5) {
            plc.mem.m2 = 1;
            r4_active = true;
            if(!prevM2) logger.add("åœæ­¢æŒ‰é’®è¢«æŒ‰ä¸‹ -> M2 ç½®ä½ (ç­‰å¾…å›ä¸­)", "warn");
        }

        // Rung 5: M2 AND X6 -> RST ALL
        let r5_active = false;
        if(plc.mem.m2 && plc.in.x6) {
            if(plc.out.y0 || plc.out.y1) {
                plc.out.y0 = 0;
                plc.out.y1 = 0;
                plc.mem.m2 = 0;
                r5_active = true;
                logger.add("å°è½¦å·²å›ä¸­ä½ X6 -> ç³»ç»Ÿè‡ªåŠ¨åœæ­¢", "info");
            }
        }

        // Rung 6: Alarm Left (X3)
        let r6_active = false;
        if(plc.in.x3) {
            plc.out.y2 = 1;
            plc.out.y0 = 0; // ç¡¬ä»¶æ€¥åœ
            plc.out.y1 = 0;
            r6_active = true;
            if(!prevY2) logger.add("!! ä¸¥é‡æ•…éšœ !! å·¦é™ä½å¤±æ•ˆå†²æ’ X3 -> Y2 æŠ¥è­¦", "err");
        }

        // Rung 7: Alarm Right (X4)
        let r7_active = false;
        if(plc.in.x4) {
            plc.out.y3 = 1;
            plc.out.y0 = 0;
            plc.out.y1 = 0;
            r7_active = true;
            if(!plc.out.y3) logger.add("!! ä¸¥é‡æ•…éšœ !! å³é™ä½å¤±æ•ˆå†²æ’ X4 -> Y3 æŠ¥è­¦", "err");
        }

        // æ›´æ–°æ¢¯å½¢å›¾é«˜äº®çŠ¶æ€ä¾› Render ä½¿ç”¨
        render.ladderState = [r1_active, r2_active, r3_active, r4_active, r5_active, r6_active, r7_active];
    }

    // --- 5. æ¸²æŸ“ ---
    function render() {
        // æ›´æ–°å°è½¦ä½ç½®
        const cartEl = document.getElementById('cart');
        cartEl.style.left = `calc(${cart.pos}% - 35px)`; // Center anchor

        // æ›´æ–°ä¼ æ„Ÿå™¨é«˜äº® (ç‰©ç†å±‚ï¼šä¸åšå»¶æ—¶ï¼ŒçœŸå®ååº”)
        const updateSen = (id, val) => document.getElementById('sen-'+id).classList.toggle('active', val===1);
        updateSen('x1', plc.in.x1);
        updateSen('x2', plc.in.x2);
        updateSen('x3', plc.in.x3);
        updateSen('x4', plc.in.x4);
        updateSen('x6', plc.in.x6);

        // æ›´æ–° LED é¢æ¿ (è§†è§‰å±‚ï¼šåŠ å…¥å»¶æ—¶ï¼Œä¾¿äºè§‚å¯Ÿ)
        const now = Date.now();
        const updateLedSmart = (id, val) => {
            const el = document.getElementById('led-'+id);
            // å¦‚æœå½“å‰æ˜¯é«˜ç”µå¹³ï¼Œåˆ·æ–°è®¡æ—¶å™¨
            if(val) {
                visualState.ledTimers[id] = now;
            }
            
            // åˆ¤å®šé€»è¾‘ï¼šå½“å‰æ˜¯é«˜ç”µå¹³ OR (ä¸Šæ¬¡é«˜ç”µå¹³çš„æ—¶é—´è·ç¦»ç°åœ¨è¿˜ä¸åˆ° HOLD_TIME)
            const shouldBeOn = val || (visualState.ledTimers[id] && (now - visualState.ledTimers[id] < visualState.HOLD_TIME));
            
            if(shouldBeOn) el.classList.add('on'); 
            else el.classList.remove('on');
        };

        updateLedSmart('x0', plc.in.x0); updateLedSmart('x5', plc.in.x5);
        updateLedSmart('x1', plc.in.x1); updateLedSmart('x2', plc.in.x2);
        updateLedSmart('x3', plc.in.x3); updateLedSmart('x4', plc.in.x4);
        updateLedSmart('x6', plc.in.x6);
        updateLedSmart('y0', plc.out.y0); updateLedSmart('y1', plc.out.y1);
        updateLedSmart('y2', plc.out.y2); 

        // æŠ¥è­¦ç¯
        document.getElementById('lamp-y2').classList.toggle('on', plc.out.y2===1);
        document.getElementById('lamp-y3').classList.toggle('on', plc.out.y3===1);

        // æ¢¯å½¢å›¾åŠ¨ç”» (ç”µæµæµå‘)
        // Helper: highlight elements inside a rung
        const highlightRung = (index, active, inputIds=[], coilIds=[]) => {
            const rung = document.getElementById(`rung-${index}`);
            if(active) {
                rung.classList.add('active-logic');
                rung.querySelectorAll('.wire').forEach(w => w.classList.add('on'));
                inputIds.forEach(id => document.getElementById(id).classList.add('on'));
                coilIds.forEach(id => document.getElementById(id).classList.add('on'));
            } else {
                rung.classList.remove('active-logic');
                rung.querySelectorAll('.wire').forEach(w => w.classList.remove('on'));
                inputIds.forEach(id => document.getElementById(id).classList.remove('on'));
                coilIds.forEach(id => document.getElementById(id).classList.remove('on'));
            }
        };

        // Rung 1: X0 -> Y0
        highlightRung(1, render.ladderState[0], ['sym-x0'], ['coil-y0-set']);
        
        // Rung 2: X1 -> Y0 RST / Y1 SET
        highlightRung(2, render.ladderState[1], ['sym-x1'], ['coil-y0-rst', 'coil-y1-set']);

        // Rung 3: X2 -> Y1 RST / Y0 SET
        highlightRung(3, render.ladderState[2], ['sym-x2'], ['coil-y1-rst', 'coil-y0-set2']);

        // Rung 4: X5 -> M2
        highlightRung(4, render.ladderState[3], ['sym-x5'], ['coil-m2']);

        // Rung 5: M2 + X6 -> RST
        highlightRung(5, render.ladderState[4], ['sym-m2', 'sym-x6'], ['coil-zrst', 'coil-m2-rst']);

        // Rung 6: X3 -> Y2
        highlightRung(6, plc.in.x3, ['sym-x3'], ['coil-y2']); // ç›´æ¥ç”¨inputçŠ¶æ€å› ä¸ºæ˜¯ç¡¬ä»¶çº§
        
        // Rung 7: X4 -> Y3
        highlightRung(7, plc.in.x4, ['sym-x4'], ['coil-y3']);
    }

</script>
</body>
</html>
