<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNN åŸç†å¯è§†åŒ– (Convolutional Neural Network)</title>
    <style>
        /* --- å…¨å±€é…è‰²ä¸å˜é‡ (å¤åˆ» PLC é£æ ¼) --- */
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #fff;
            --primary-blue: #2c3e50;
            --cell-default: #3498db;
            --cell-active: #2980b9;     /* æ¿€æ´»æ€ */
            --cell-relu: #aed6f1;       /* ReLUå */
            --scanner-border: #ff9800;  /* æ‰«ææ¡†æ©™è‰² */
            --highlight: #fff9c4;       /* æ—¥å¿—é«˜äº® */
            --text-grey: #555;
            --math-bg: #fafafa;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 20px; user-select: none;
        }

        h2 { color: #333; margin-bottom: 5px; }
        .sub-title { color: #666; font-size: 14px; margin-bottom: 20px; }

        /* --- ä¸»å®¹å™¨å¸ƒå±€ (Grid) --- */
        .container {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 20px;
            width: 1000px;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0;
            font-weight: bold; color: #555;
        }

        /* --- å·¦ä¾§ï¼šå¯è§†åŒ–è§†å›¾ (Visual View) --- */
        #left-panel { height: 500px; align-items: center; justify-content: center; position: relative; }

        .grid-container {
            position: relative;
            padding: 20px;
            margin-top: 20px;
        }

        /* 5x5 çŸ©é˜µ */
        #cnn-grid {
            display: grid;
            grid-template-columns: repeat(5, 60px);
            grid-template-rows: repeat(5, 60px);
            gap: 10px;
        }

        .cell {
            width: 60px; height: 60px;
            background-color: var(--cell-default);
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold;
            border-radius: 8px;
            transition: all 0.5s ease;
            position: relative;
            z-index: 10;
        }

        /* ReLU æ¿€æ´»æ ·å¼ */
        .cell.relu-mode {
            background-color: var(--cell-relu);
            color: var(--primary-blue);
            transform: scale(0.92);
            border: 2px solid var(--cell-default);
        }

        /* æ‰«ææ¡† (Kernel / Pool Window) */
        #scanner {
            position: absolute;
            top: 20px; left: 20px; /* Initial align with padding */
            border: 4px solid var(--scanner-border);
            border-radius: 10px;
            box-sizing: border-box;
            pointer-events: none;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 20;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
        }

        /* æ‰«ææ¡†æ ‡ç­¾ */
        #scanner-label {
            position: absolute;
            top: -25px; left: 0;
            background: var(--scanner-border);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        /* --- å³ä¾§ï¼šé€»è¾‘æ§åˆ¶ä¸ä¸Šå¸è§†è§’ (Logic & Control) --- */
        #right-panel { height: 500px; gap: 15px; padding: 0; }
        .right-content { padding: 15px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .controls {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .btn {
            background: var(--primary-blue); color: #fff; border: none; padding: 8px 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { background: #34495e; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .status-badge {
            background: #eee; padding: 5px 10px; border-radius: 12px; font-size: 12px; color: #666; font-weight: bold;
        }

        /* åŸç†å±•ç¤ºåŒº (æ›¿ä»£æ¢¯å½¢å›¾) */
        .math-box {
            flex: 1; background: var(--math-bg); border: 1px solid #ddd; border-radius: 8px;
            padding: 20px; position: relative; font-family: 'Consolas', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .math-title { color: var(--primary-blue); font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .math-formula { font-size: 20px; color: #333; margin-bottom: 10px; text-align: center; }
        .math-desc { font-size: 13px; color: #777; text-align: center; line-height: 1.5; }
        
        .visual-icon {
            font-size: 40px; margin-bottom: 10px; color: var(--scanner-border);
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .logger {
            height: 180px; background: #fafafa; border-top: 1px solid #eee; padding: 10px; overflow-y: auto; margin-top: 15px;
        }
        .log-line { 
            font-size: 13px; color: #555; padding: 6px 10px; 
            margin-bottom: 4px; border-radius: 4px; border-left: 3px solid transparent; 
            transition: 0.2s; 
        }
        .log-line.active { 
            background: var(--highlight); color: #333; font-weight: bold; border-left-color: var(--scanner-border); 
        }

    </style>
</head>
<body>

    <h2>CNN ç¥ç»ç½‘ç»œç»“æ„æ¼”ç¤º</h2>
    <div class="sub-title">ä¸Šå¸è§†è§’è§£è¯´ï¼šè§‚å¯Ÿ Input Grid å¦‚ä½•ä¾æ¬¡ç»è¿‡ å·ç§¯ã€æ¿€æ´»ã€æ± åŒ– å¤„ç†ã€‚</div>

    <div class="container">
        <!-- å·¦ä¾§ï¼šå¯è§†åŒ–åŠ¨ç”» -->
        <div class="panel" id="left-panel">
            <div class="header">å¯è§†åŒ–è§†å›¾ (Feature Map)</div>
            
            <div class="grid-container">
                <div id="cnn-grid">
                    <!-- JSç”Ÿæˆæ ¼å­ -->
                </div>
                <!-- æµ®åŠ¨çš„æ‰«ææ¡† -->
                <div id="scanner">
                    <div id="scanner-label">Kernel</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶ä¸åŸç†è§£è¯´ -->
        <div class="panel" id="right-panel">
            <div class="right-content">
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="controls">
                    <span class="status-badge" id="status-text">ç³»ç»Ÿå°±ç»ª (Ready)</span>
                    <button class="btn" id="start-btn" onclick="ctl.startSequence()">å¼€å§‹æ¼”ç¤º (Start)</button>
                </div>

                <!-- æ ¸å¿ƒé€»è¾‘å±•ç¤º (ç±»ä¼¼æ¢¯å½¢å›¾åŒºåŸŸ) -->
                <div class="math-box" id="math-view">
                    <div class="visual-icon">âš™ï¸</div>
                    <div class="math-title">ç­‰å¾…æŒ‡ä»¤</div>
                    <div class="math-formula">...</div>
                    <div class="math-desc">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å¤„ç†æµç¨‹</div>
                </div>

                <!-- æ—¥å¿— (ç±»ä¼¼ PLC Logger) -->
                <div class="logger">
                    <div class="log-line active" id="log-idle">0. å°±ç»ªï¼šè¾“å…¥çŸ©é˜µ (5x5) å·²åŠ è½½ï¼ŒåŒ…å«éšæœºåƒç´ å€¼ã€‚</div>
                    <div class="log-line" id="log-conv">1. å·ç§¯å±‚ (Conv): 3x3 å·ç§¯æ ¸æ»‘åŠ¨ï¼Œæå–å±€éƒ¨ç‰¹å¾ã€‚</div>
                    <div class="log-line" id="log-relu">2. æ¿€æ´»å±‚ (ReLU): è¿‡æ»¤è´Ÿå€¼ï¼Œå¼•å…¥éçº¿æ€§ç‰¹æ€§ã€‚</div>
                    <div class="log-line" id="log-pool">3. æ± åŒ–å±‚ (Pooling): 2x2 çª—å£æœ€å¤§å€¼é‡‡æ ·ï¼Œé™ä½ç»´åº¦ã€‚</div>
                    <div class="log-line" id="log-done">4. å®Œæˆï¼šç‰¹å¾æå–å®Œæ¯•ï¼Œå‡†å¤‡ä¼ å…¥å…¨è¿æ¥å±‚ã€‚</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- 1. æ•°æ®é…ç½® ---
    const config = {
        gridSize: 5,
        cellSize: 60,
        gapSize: 10,
        stepTime: 1200 // åŠ¨ç”»æ¯æ­¥é—´éš” ms
    };

    // --- 2. è§†å›¾å±‚ (UI) ---
    const ui = {
        grid: document.getElementById('cnn-grid'),
        scanner: document.getElementById('scanner'),
        scannerLabel: document.getElementById('scanner-label'),
        mathBox: document.getElementById('math-view'),
        statusBadge: document.getElementById('status-text'),
        startBtn: document.getElementById('start-btn'),

        // åˆå§‹åŒ–ç½‘æ ¼
        initGrid: () => {
            ui.grid.innerHTML = '';
            for (let i = 0; i < config.gridSize * config.gridSize; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                // éšæœºæ•°å€¼ -2 ~ 5
                let val = Math.floor(Math.random() * 8) - 2;
                cell.innerText = val;
                cell.dataset.val = val; 
                cell.id = `c-${Math.floor(i/5)}-${i%5}`; // c-row-col
                ui.grid.appendChild(cell);
            }
        },

        // æ›´æ–°æ‰«ææ¡†ä½ç½®
        moveScanner: (r, c, size, label) => {
            // è®¡ç®— CSS
            const padding = 20; // çˆ¶å®¹å™¨ padding
            const left = padding + c * (config.cellSize + config.gapSize);
            const top = padding + r * (config.cellSize + config.gapSize);
            const w = size * config.cellSize + (size - 1) * config.gapSize;
            
            ui.scanner.style.width = w + 'px';
            ui.scanner.style.height = w + 'px'; // æ­£æ–¹å½¢
            ui.scanner.style.left = left + 'px';
            ui.scanner.style.top = top + 'px';
            ui.scanner.style.opacity = 1;
            ui.scannerLabel.innerText = label;
        },

        hideScanner: () => {
            ui.scanner.style.opacity = 0;
        },

        // æ›´æ–°å•ä¸ªæ ¼å­æ˜¾ç¤º (ç”¨äº ReLU)
        updateCell: (el, val, mode) => {
            el.innerText = val;
            if (mode === 'relu') el.classList.add('relu-mode');
            else el.classList.remove('relu-mode');
        },

        // æ›´æ–°â€œä¸Šå¸è§†è§’â€æ•°å­¦é¢æ¿
        updateMath: (title, formula, desc, icon) => {
            ui.mathBox.innerHTML = `
                <div class="visual-icon">${icon}</div>
                <div class="math-title">${title}</div>
                <div class="math-formula">${formula}</div>
                <div class="math-desc">${desc}</div>
            `;
        },

        // æ—¥å¿—é«˜äº®
        highlightLog: (id) => {
            document.querySelectorAll('.log-line').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        },

        // æŒ‰é’®çŠ¶æ€
        setRunning: (isRunning) => {
            ui.startBtn.disabled = isRunning;
            ui.startBtn.innerText = isRunning ? "æ¼”ç¤ºè¿›è¡Œä¸­..." : "é‡æ–°å¼€å§‹æ¼”ç¤º";
            ui.statusBadge.innerText = isRunning ? "è¿è¡Œä¸­ (Running)" : "å¾…æœº (Standby)";
            ui.statusBadge.style.color = isRunning ? "#2980b9" : "#666";
        }
    };

    // --- 3. æ§åˆ¶å±‚ (Controller) ---
    const ctl = {
        // è¾…åŠ©ï¼šç­‰å¾…å‡½æ•°
        wait: (ms) => new Promise(resolve => setTimeout(resolve, ms)),

        // æ ¸å¿ƒæµç¨‹
        startSequence: async () => {
            ui.setRunning(true);
            
            // 0. é‡ç½®
            ui.initGrid();
            ui.highlightLog('log-idle');
            ui.updateMath("å‡†å¤‡å°±ç»ª", "Input Matrix (5x5)", "åŸå§‹å›¾åƒåƒç´ å€¼", "ğŸ²");
            await ctl.wait(1000);

            // 1. å·ç§¯
            await ctl.runConvolution();

            // 2. æ¿€æ´»
            await ctl.runReLU();

            // 3. æ± åŒ–
            await ctl.runPooling();

            // 4. ç»“æŸ
            ui.highlightLog('log-done');
            ui.updateMath("å¤„ç†å®Œæˆ", "Output Feature Map", "æ•°æ®å·²å‡†å¤‡å¥½è¿›å…¥å…¨è¿æ¥å±‚", "ğŸ");
            ui.setRunning(false);
        },

        runConvolution: async () => {
            ui.highlightLog('log-conv');
            
            const kSize = 3;
            const limit = config.gridSize - kSize;

            for (let r = 0; r <= limit; r++) {
                for (let c = 0; c <= limit; c++) {
                    // ä¸ºäº†æ¼”ç¤ºä¸è‡³äºå¤ªé•¿ï¼Œåªæ¼”ç¤ºéƒ¨åˆ†è·¯å¾„ (ä¾‹å¦‚å¯¹è§’çº¿æˆ–ç‰¹å®šç‚¹)ï¼Œæˆ–è€…åŠ å¿«é€Ÿåº¦
                    // è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºç¬¬ä¸€è¡Œçš„ç§»åŠ¨
                    if (r > 0 && c > 0 && r < limit && c < limit) continue; // è·³è¿‡ä¸­é—´éƒ¨åˆ†ä»¥èŠ‚çœæ—¶é—´

                    ui.moveScanner(r, c, kSize, "Kernel 3x3");
                    
                    // åŠ¨æ€æ›´æ–°æ•°å­¦é¢æ¿
                    ui.updateMath(
                        `å·ç§¯è¿ç®— (Step ${r},${c})`, 
                        `Output = âˆ‘ (Input Ã— Kernel) + Bias`, 
                        `å·ç§¯æ ¸ä¸å¯¹åº”åŒºåŸŸåƒç´ ç›¸ä¹˜æ±‚å’Œã€‚<br>æå–è¾¹ç¼˜ã€çº¹ç†ç­‰ç‰¹å¾ã€‚`,
                        "âœ–ï¸"
                    );
                    
                    await ctl.wait(config.stepTime);
                }
            }
            ui.hideScanner();
            await ctl.wait(500);
        },

        runReLU: async () => {
            ui.highlightLog('log-relu');
            ui.updateMath(
                "ReLU æ¿€æ´»å‡½æ•°", 
                "f(x) = max(0, x)", 
                "éå†æ‰€æœ‰åƒç´ ï¼š<br>å¦‚æœæ˜¯è´Ÿæ•°åˆ™ç½®ä¸º0ï¼Œæ­£æ•°ä¿æŒä¸å˜ã€‚",
                "ğŸ“ˆ"
            );

            const cells = document.querySelectorAll('.cell');
            // æ¨¡æ‹Ÿå¿«é€Ÿæ‰«æå¤„ç†
            for (let i = 0; i < cells.length; i++) {
                let val = parseInt(cells[i].dataset.val);
                if (val < 0) {
                    ui.updateCell(cells[i], 0, 'relu');
                } else {
                    ui.updateCell(cells[i], val, 'relu');
                }
                // æ¯éš”å‡ ä¸ªæ ¼å­åœé¡¿ä¸€ä¸‹ï¼Œåˆ¶é€ â€œæ‰«ææ„Ÿâ€
                if (i % 5 === 0) await ctl.wait(200);
            }
            await ctl.wait(1000);
        },

        runPooling: async () => {
            ui.highlightLog('log-pool');
            
            const pSize = 2;
            const stride = 2;
            
            // éå† stride
            for (let r = 0; r < config.gridSize - 1; r += stride) {
                for (let c = 0; c < config.gridSize - 1; c += stride) {
                    ui.moveScanner(r, c, pSize, "Max Pool");
                    
                    ui.updateMath(
                        "æœ€å¤§æ± åŒ– (Max Pooling)", 
                        "Output = Max(Window)", 
                        `åœ¨ 2x2 çª—å£ä¸­ä¿ç•™æœ€å¤§å€¼ã€‚<br>å‹ç¼©æ•°æ®é‡ï¼Œä¿ç•™æ˜¾è‘—ç‰¹å¾ã€‚`,
                        "ğŸ”"
                    );
                    
                    await ctl.wait(config.stepTime);
                }
            }
            ui.hideScanner();
        }
    };

    // åˆå§‹åŒ–
    window.onload = () => {
        ui.initGrid();
    };

</script>
</body>
</html>