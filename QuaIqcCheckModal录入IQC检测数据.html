<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQC 进料检验逻辑上帝视角演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');

        :root {
            --ant-primary: #1890ff;
            --ant-bg: #f5f5f5;
            --ant-border: #d9d9d9;
            --ant-header-bg: #fafafa;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; }

        /* 模拟 Ant Design 表单样式 */
        .ant-input {
            border: 1px solid var(--ant-border);
            padding: 4px 11px;
            border-radius: 2px;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }
        .ant-input:disabled { background-color: #f5f5f5; cursor: not-allowed; color: rgba(0,0,0,0.45); }
        .ant-label { color: rgba(0,0,0,0.85); font-size: 14px; text-align: right; width: 110px; }
        .required::before { content: '*'; color: #ff4d4f; margin-right: 4px; }

        /* 日志瀑布流 */
        #god-view-log {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .log-entry {
            border-left: 2px solid #4a5568;
            padding-left: 10px;
            margin-bottom: 8px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* API 节点动画 */
        .api-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; }
        .api-active { border-color: var(--ant-primary); background: rgba(24, 144, 255, 0.05); transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .api-method { font-family: 'Fira Code', monospace; font-weight: bold; font-size: 10px; padding: 2px 4px; border-radius: 2px; }

        /* 表格动画 */
        .row-new { animation: rowHighlight 1.5s ease-out; }
        @keyframes rowHighlight { 0% { background-color: #e6f7ff; } 100% { background-color: transparent; } }
        
        /* 代码块显示 */
        .code-block { font-family: 'Fira Code', monospace; background: #1a202c; color: #a0aec0; padding: 6px; border-radius: 4px; font-size: 11px; margin-top: 4px; }
        .code-highlight { color: #f6e05e; }
    </style>
</head>
<body class="p-4">

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6">
    
    <!-- 左侧：UI 模拟区 -->
    <div class="col-span-8 bg-white shadow-lg rounded-sm border border-gray-200 flex flex-col min-h-[900px]">
        <div class="px-4 py-3 border-b flex justify-between items-center">
            <h2 class="text-base font-medium">编辑检验记录</h2>
            <div class="space-x-2">
                <button class="px-4 py-1 border text-sm hover:border-blue-400 hover:text-blue-400">取消</button>
                <button class="px-4 py-1 bg-blue-500 text-white text-sm hover:bg-blue-600">保存</button>
            </div>
        </div>

        <div class="p-6">
            <!-- 基础信息表单 -->
            <div class="grid grid-cols-2 gap-y-4 gap-x-12 mb-8">
                <div class="flex items-center"><label class="ant-label required">暂收单：</label><input class="ant-input ant-input-disabled" value="C-2026-A001"></div>
                <div class="flex items-center"><label class="ant-label required">产品型号：</label><input id="ui-model" class="ant-input ant-input-disabled" value="待加载..."></div>
                <div class="flex items-center"><label class="ant-label required">检验类型：</label>
                    <select id="ui-check-type" class="ant-input cursor-pointer border-blue-400" onchange="triggerSamplingLogic()">
                        <option value="">请选择检验类型</option>
                        <option value="性能类">性能类</option>
                        <option value="尺寸类">尺寸类</option>
                        <option value="外观类">外观类</option>
                    </select>
                </div>
                <div class="flex items-center"><label class="ant-label required">物料编号：</label><input id="ui-material-code" class="ant-input ant-input-disabled" value="MAT-COMMON-01"></div>
                <div class="flex items-center"><label class="ant-label">抽样数量：</label><input id="ui-extract-qty" class="ant-input ant-input-disabled font-bold text-blue-600" value=""></div>
                <div class="flex items-center"><label class="ant-label">物料名称：</label><input class="ant-input ant-input-disabled" value="某某品牌电芯组件"></div>
                <div class="flex items-center"><label class="ant-label">拒收数量：</label><input id="ui-deny-qty" class="ant-input ant-input-disabled text-red-500" value=""></div>
                <div class="flex items-center"><label class="ant-label">物料供应商：</label><input class="ant-input ant-input-disabled" value="某某科技有限公司"></div>
                <div class="flex items-center"><label class="ant-label">前三批异常：</label><input id="ui-last3" class="ant-input ant-input-disabled" value="正在查询..."></div>
                <div class="flex items-center"><label class="ant-label">开封箱登记：</label>
                    <div class="flex w-full border rounded">
                        <button class="flex-1 py-1 text-xs hover:bg-gray-100 border-r" onclick="triggerBoxLogic('open')">开箱</button>
                        <button class="flex-1 py-1 text-xs hover:bg-gray-100" onclick="triggerBoxLogic('close')">封箱</button>
                    </div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="border rounded-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b text-gray-600">
                        <tr>
                            <th class="py-2 border-r w-12 text-center">#</th>
                            <th class="py-2 border-r w-24">结果</th>
                            <th class="py-2 border-r bg-blue-50 border-b-blue-200">code (条码序列)</th>
                            <th class="py-2 border-r">测量值-A</th>
                            <th class="py-2">测量值-B</th>
                        </tr>
                    </thead>
                    <tbody id="ui-table-body" class="divide-y text-gray-500">
                        <tr><td colspan="5" class="py-20 text-center italic text-gray-300">请选择检验类型触发核心采样逻辑</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex items-center justify-between">
                <div id="ui-standard-doc" class="text-blue-500 text-xs cursor-pointer hover:underline">指导书：加载中...</div>
                <div class="space-x-2">
                    <button class="px-3 py-1 border text-xs bg-gray-50">下载结果模板</button>
                    <button class="px-3 py-1 border text-xs bg-gray-50">上传实测值 (Excel)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧：上帝视角 & API 面板 -->
    <div class="col-span-4 flex flex-col h-[900px]">
        
        <!-- 上帝视角日志 (瀑布流) -->
        <div class="flex-1 bg-slate-900 rounded-t-lg p-4 overflow-hidden flex flex-col border-b border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-ping"></span>
                    God's View Narrative Log
                </h3>
                <span class="text-slate-600 text-[10px] font-mono">Stream: active</span>
            </div>
            <div id="god-view-log" class="flex-1 overflow-y-auto pr-2 text-sm space-y-3 font-light text-slate-300">
                <!-- 日志条目动态插入 -->
                <div class="log-entry">系统启动，等待用户触发初始化...</div>
            </div>
        </div>

        <!-- API 常驻面板 -->
        <div class="bg-slate-800 p-4 rounded-b-lg overflow-y-auto h-[450px]">
            <h4 class="text-slate-500 text-[10px] font-bold mb-4 uppercase">API Network Activity</h4>
            <div id="api-activity-list" class="space-y-3">
                
                <!-- 初始化组 -->
                <div class="text-[9px] text-slate-600 font-bold border-b border-slate-700 mb-2">PHASE 1: INITIALIZATION</div>
                <div id="api-init-model" class="api-card p-2 rounded bg-slate-900/50">
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="api-method bg-blue-900 text-blue-300">GET</span>
                        <span class="text-slate-400 font-mono">/masterProductModeQueryByBu</span>
                    </div>
                    <div class="text-[10px] text-slate-500">获取物料对应的产品型号列表</div>
                </div>
                <div id="api-init-combine" class="api-card p-2 rounded bg-slate-900/50">
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="api-method bg-blue-900 text-blue-300">GET</span>
                        <span class="text-slate-400 font-mono">/getIqcCombineCheckInfo</span>
                    </div>
                    <div class="text-[10px] text-slate-500">多暂收单物料合并统计</div>
                </div>

                <!-- 采样逻辑组 -->
                <div class="text-[9px] text-slate-600 font-bold border-b border-slate-700 mb-2 mt-4">PHASE 2: SAMPLING & CALC</div>
                <div id="api-calc-list" class="api-card p-2 rounded bg-slate-900/50">
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="api-method bg-green-900 text-green-300">GET</span>
                        <span class="text-slate-400 font-mono">/getIQCResultList</span>
                    </div>
                    <div class="text-[10px] text-slate-500">查询数据库是否存在历史/暂存记录</div>
                </div>
                <div id="api-calc-level" class="api-card p-2 rounded bg-slate-900/50">
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="api-method bg-green-900 text-green-300">GET</span>
                        <span class="text-slate-400 font-mono">/getIqcSampleLevel</span>
                    </div>
                    <div class="text-[10px] text-slate-500">核心算法：根据AQL计算抽样数</div>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="mt-6 grid grid-cols-2 gap-3">
                <button onclick="runScenario('init')" class="bg-blue-600 text-white text-xs py-2 rounded hover:bg-blue-700">执行初始化</button>
                <button onclick="runScenario('history')" class="bg-slate-700 text-white text-xs py-2 rounded hover:bg-slate-600">模拟加载历史</button>
            </div>
        </div>
    </div>
</div>

<script>
    const logBox = document.getElementById('god-view-log');
    const tableBody = document.getElementById('ui-table-body');
    const narrativeDelay = 800;

    // --- 通用函数 ---
    function addLog(msg, isCode = false) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        if(isCode) {
            div.innerHTML = `<span class="text-blue-400 font-bold">LOG:</span> ${msg}`;
        } else {
            div.innerHTML = `<span class="text-gray-500 font-mono text-[10px]">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        }
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function highlightApi(id, status = 'pending') {
        const el = document.getElementById(id);
        if(status === 'pending') {
            el.classList.add('api-active');
        } else {
            el.classList.remove('api-active');
            el.classList.add('border-green-500/50');
        }
    }

    // --- 业务场景模拟 ---

    async function runScenario(type) {
        if(type === 'init') {
            addLog(">>> 开始执行 [初始化阶段] 逻辑串联...");
            
            // 1. BU型号获取
            highlightApi('api-init-model');
            addLog("上帝视角：前端检测到 BU 变更。调用 masterProductModeQueryByBu 获取物料所属的型号：MOD-BATT-001。");
            await new Promise(r => setTimeout(r, narrativeDelay));
            document.getElementById('ui-model').value = "MOD-BATT-001";

            // 2. 合并信息
            highlightApi('api-init-combine');
            addLog("上帝视角：调用 getIqcCombineCheckInfo。后端反馈：该供应商在今天有2个相同物料的暂收单，已自动汇总数量。");
            await new Promise(r => setTimeout(r, narrativeDelay));

            // 3. 前三批异常
            addLog("上帝视角：调用 getLast3BatchException。查询该物料与供应商的最近3次质量履历...");
            await new Promise(r => setTimeout(r, narrativeDelay));
            document.getElementById('ui-last3').value = "无异常 (质量优良)";
            document.getElementById('ui-last3').style.color = "green";
            
            addLog("初始化完成。等待用户选择检验类型以进入核心逻辑。");
        }

        if(type === 'history') {
            addLog(">>> 开始模拟 [加载历史记录] 场景...");
            highlightApi('api-calc-list');
            addLog("上帝视角：检测到当前暂收单存在保存记录。调用 getIQCResultList 接口。");
            
            await new Promise(r => setTimeout(r, 1000));
            addLog("接口响应成功：后端返回了真实的 SN 序列号。");

            const history = [
                {sn: 'SN-001-A2026', res: 'OK'},
                {sn: 'SN-002-A2026', res: 'OK'},
                {sn: 'SN-003-A2026', res: 'NG'}
            ];
            
            renderTable(history, false);
            document.getElementById('ui-extract-qty').value = history.length;
            addLog("由于数据库已有 SN，跳过前端 1, 2, 3 自动生成逻辑。");
        }
    }

    // 关键逻辑：选择检验类型
    async function triggerSamplingLogic() {
        const type = document.getElementById('ui-check-type').value;
        if(!type) return;

        addLog(`>>> 触发核心采样逻辑：用户选择了 [${type}]`);
        
        // 1. 指导书获取
        highlightApi('api-calc-list');
        addLog("上帝视角：调用 queryIQCTestItem 获取该型号的检验参数及标准文档。");
        await new Promise(r => setTimeout(r, 800));
        document.getElementById('ui-standard-doc').innerText = `指导书：${type}检验标准指导书_V1.2.pdf`;

        // 2. 采样水准确定
        addLog("上帝视角：调用 listAll (CheckStatus)。检查物料状态：处于 [正常检验] 水准。");
        await new Promise(r => setTimeout(r, 600));

        // 3. 采样计算 (最关键步骤)
        highlightApi('api-calc-level');
        addLog("上帝视角：发起 getIqcSampleLevel 请求。逻辑：输入物料总数(100) + AQL水准(0.65)。");
        await new Promise(r => setTimeout(r, 1200));

        const extractQty = 3;
        const denyQty = 1;
        document.getElementById('ui-extract-qty').value = extractQty;
        document.getElementById('ui-deny-qty').value = denyQty;
        
        addLog(`接口反馈：本次判定基准为 AC:0, RE:${denyQty}。需抽检 <span class='text-blue-400 font-bold'>${extractQty}</span> 件。`);

        // 4. 前端 Table 渲染 (1, 2, 3 来源)
        addLog("核心逻辑触发：由于数据库无历史 SN，前端 init2dTable 方法开始工作...");
        
        const codeBlock = `
for (let i = 0; i < extractQty; i++) {
  const row = {
    code: (i + 1) + '', // 生成占位符 1, 2, 3...
    quaIqcCheckValue: [...]
  };
  this.model.quaIqcCheckItemVo.push(row);
}`;
        addLog(`<div class="code-block">${codeBlock.replace(/\n/g, '<br>')}</div>`);
        
        await new Promise(r => setTimeout(r, 1500));
        renderTable([1, 2, 3], true);
        addLog("上帝视角：表格渲染完毕。code 列已被赋值为 1, 2, 3。现在检验员可以开始扫码覆盖这些数字。");
    }

    function renderTable(data, isGenerated) {
        tableBody.innerHTML = '';
        data.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = 'row-new';
            const codeVal = isGenerated ? item : item.sn;
            const codeClass = isGenerated ? 'text-blue-500 font-bold italic' : 'text-gray-800 font-mono';
            
            tr.innerHTML = `
                <td class="py-2 border-r text-center text-xs text-gray-400">${index + 1}</td>
                <td class="py-2 border-r text-center">-</td>
                <td class="py-2 border-r px-2">
                    <div class="border rounded px-2 py-1 bg-blue-50/50 ${codeClass}">
                        ${codeVal}
                    </div>
                </td>
                <td class="py-2 border-r px-2"><input class="w-full text-xs outline-none" placeholder="输入测量值..."></td>
                <td class="py-2 px-2"><input class="w-full text-xs outline-none" placeholder="输入测量值..."></td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function triggerBoxLogic(action) {
        const msg = action === 'open' ? "开箱登记" : "封箱登记";
        addLog(`>>> 触发 [箱号管理]：调用 oCBoxRegistration 接口。`);
        highlightApi('api-calc-level'); // 借用一下展示活跃
        addLog(`上帝视角：后端实时记录该批次的${msg}状态。`);
    }

</script>
</body>
</html>