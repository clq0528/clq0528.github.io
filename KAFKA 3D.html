<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Kafka ä¸“å®¶çº§ç‰©ç†æ‹“æ‰‘æ¼”ç¤º</title>
    <style>
        :root {
            --panel-bg: rgba(15, 23, 42, 0.95);
            --neon-blue: #00d2ff;
            --neon-green: #39ff14;
            --neon-gold: #ffcc00;
        }
        body { margin: 0; background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* äº¤äº’é¢æ¿ */
        #ui-layer { position: absolute; top: 25px; left: 25px; z-index: 100; width: 320px; }
        .expert-panel {
            background: var(--panel-bg);
            border: 2px solid #1e293b;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
        }
        h2 { margin: 0 0 20px 0; font-size: 20px; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        
        button {
            width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 8px;
            background: #1e293b; color: #fff; cursor: pointer; transition: all 0.2s;
            font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center;
        }
        button:hover:not(:disabled) { background: var(--neon-blue); color: #000; transform: scale(1.02); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* ä¸Šå¸è§†è§’åŠ¨æ€æ—¥å¿— */
        #log-panel { position: absolute; right: 25px; top: 25px; width: 350px; height: 90vh; pointer-events: none; overflow: hidden; }
        .log-card {
            background: rgba(15, 23, 42, 0.8); border-left: 4px solid var(--neon-blue);
            padding: 15px; margin-bottom: 12px; font-size: 13px; border-radius: 4px;
            animation: slideIn 0.3s ease-out; backdrop-filter: blur(5px);
        }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* 3D æ ‡ç­¾ */
        .tag { background: rgba(0,0,0,0.85); color: #fff; padding: 4px 12px; border: 1px solid #334155; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; }
        .tag-leader { border-color: #ef4444; color: #ef4444; }
        .tag-topic { border-color: var(--neon-gold); color: var(--neon-gold); font-size: 14px; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="expert-panel">
        <h2>Kafka Engine v3.0</h2>
        <button id="btn-init">âš¡ åˆå§‹åŒ–é›†ç¾¤æ¶æ„</button>
        <button id="btn-produce" disabled>ğŸ•Š å‘é€é£é¸½æ¶ˆæ¯ (Topic)</button>
        <button id="btn-consume" disabled>ğŸ“¥ æ¶ˆè´¹è€…æ‹‰å–æ•°æ®</button>
        <button id="btn-reset">â†º ç‰©ç†æ‹“æ‰‘é‡ç½®</button>
        <div style="font-size: 11px; color: #64748b; margin-top: 15px;">ä¸“å®¶æ³¨ï¼šTopic æ˜¯é€»è¾‘ä¸Šçš„æ¶ˆæ¯ä¸­å¿ƒï¼ŒBroker æ˜¯ç‰©ç†æ‰¿è½½å®ä½“ã€‚</div>
    </div>
</div>

<div id="log-panel"></div>

<script type="module">
    import * as THREE from "https://esm.sh/three@0.165.0";
    import { OrbitControls } from "https://esm.sh/three@0.165.0/examples/jsm/controls/OrbitControls.js";
    import { CSS2DRenderer, CSS2DObject } from "https://esm.sh/three@0.165.0/examples/jsm/renderers/CSS2DRenderer.js";
    import TWEEN from "https://esm.sh/@tweenjs/tween.js";

    // å…¨å±€è®¾ç½®
    let scene, camera, renderer, labelRenderer, controls;
    let brokers = [], partitions = [], topicCenter;
    let producerPC, consumerPC;

    const COLORS = {
        bg: 0x020617,
        broker: 0x334155,
        topic: 0xffcc00,
        leader: 0xef4444,
        follower: 0x3b82f6,
        cable: 0x1e293b,
        cableActive: 0x00d2ff
    };

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(COLORS.bg);
        scene.fog = new THREE.Fog(COLORS.bg, 100, 250);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(100, 80, 150);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0';
        labelRenderer.domElement.style.pointerEvents = 'none';
        document.body.appendChild(labelRenderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // ä¸“å®¶çº§å…‰å½±
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(50, 100, 50);
        scene.add(dirLight);

        // äº®è“è‰²ç§‘æŠ€ç½‘æ ¼
        const grid = new THREE.GridHelper(300, 30, 0x1e293b, 0x0f172a);
        scene.add(grid);

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    // åˆ›å»ºâ€œé£é¸½â€æ¶ˆæ¯å®ä½“
    function createPigeon() {
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.8, 2), new THREE.MeshStandardMaterial({color: COLORS.topic, emissive: COLORS.topic, emissiveIntensity: 0.5}));
        group.add(body);
        
        // ç®€æ˜“ç¿…è†€
        const wingGeo = new THREE.PlaneGeometry(2, 1);
        const wingMat = new THREE.MeshBasicMaterial({color: 0xffffff, side: THREE.DoubleSide});
        const leftWing = new THREE.Mesh(wingGeo, wingMat);
        leftWing.position.set(-1.5, 0.5, 0);
        leftWing.rotation.z = Math.PI/4;
        const rightWing = leftWing.clone();
        rightWing.position.set(1.5, 0.5, 0);
        rightWing.rotation.z = -Math.PI/4;
        group.add(leftWing, rightWing);

        // ç¿…è†€æ‰‡åŠ¨åŠ¨ç”»
        new TWEEN.Tween(leftWing.rotation).to({z: -Math.PI/4}, 200).yoyo(true).repeat(Infinity).start();
        new TWEEN.Tween(rightWing.rotation).to({z: Math.PI/4}, 200).yoyo(true).repeat(Infinity).start();
        
        return group;
    }

    // åˆ›å»ºä¸“å®¶çº§æœåŠ¡å™¨æœºæ¶ (Broker)
    function createBrokerRack(id, pos) {
        const group = new THREE.Group();
        // å¤–å£³
        const frame = new THREE.Mesh(new THREE.BoxGeometry(12, 25, 12), new THREE.MeshStandardMaterial({color: 0x1e293b, metalness: 0.8, roughness: 0.2}));
        group.add(frame);
        
        // å†…éƒ¨é—ªçƒç¯å…‰
        for(let i=0; i<5; i++) {
            const led = new THREE.Mesh(new THREE.BoxGeometry(8, 0.5, 0.5), new THREE.MeshBasicMaterial({color: 0x00ff00}));
            led.position.set(0, 10 - i*4, 6.1);
            group.add(led);
            // éšæœºé—ªçƒ
            setInterval(() => led.material.color.set(Math.random() > 0.5 ? 0x00ff00 : 0x003300), 200 + Math.random()*500);
        }

        group.position.copy(pos);
        group.add(new CSS2DObject(createLabel(`Broker Node-${id}`)));
        scene.add(group);
        return { group, id };
    }

    // åˆ›å»ºå®ä½“åŒ–ç”µè„‘
    function createPCWorkstation(name, color, pos) {
        const group = new THREE.Group();
        // æœºç®±
        const main = new THREE.Mesh(new THREE.BoxGeometry(6, 10, 8), new THREE.MeshStandardMaterial({color: 0x334155}));
        group.add(main);
        // æ˜¾ç¤ºå™¨
        const screen = new THREE.Mesh(new THREE.BoxGeometry(10, 6, 0.5), new THREE.MeshStandardMaterial({color: 0x000000}));
        screen.position.set(0, 4, 6);
        group.add(screen);
        // å±å¹•å‘å…‰è‰²
        const monitor = new THREE.Mesh(new THREE.PlaneGeometry(9, 5), new THREE.MeshBasicMaterial({color: color, transparent: true, opacity: 0.4}));
        monitor.position.set(0, 4, 6.3);
        group.add(monitor);

        group.position.copy(pos);
        group.add(new CSS2DObject(createLabel(name)));
        scene.add(group);
        return group;
    }

    // ç»˜åˆ¶å‘å…‰ç®¡é“ (å…‰çº¤)
    function createTubeCable(p1, p2) {
        const curve = new THREE.CatmullRomCurve3([p1, new THREE.Vector3((p1.x+p2.x)/2, 50, (p1.z+p2.z)/2), p2]);
        const tubeGeo = new THREE.TubeGeometry(curve, 32, 0.4, 8, false);
        const tubeMat = new THREE.MeshStandardMaterial({color: COLORS.cable, emissive: COLORS.cable, transparent: true, opacity: 0.5});
        const tube = new THREE.Mesh(tubeGeo, tubeMat);
        scene.add(tube);
        return tube;
    }

    // åˆ›å»ºä¸­å¿ƒ Topic (é£é¸½ä¸­å¿ƒ)
    function createTopicCenter() {
        const group = new THREE.Group();
        const geo = new THREE.SphereGeometry(8, 32, 32);
        const mat = new THREE.MeshStandardMaterial({color: COLORS.topic, emissive: COLORS.topic, emissiveIntensity: 0.8, wireframe: true});
        const sphere = new THREE.Mesh(geo, mat);
        group.add(sphere);
        
        const label = new CSS2DObject(createLabel("Topic: Order_Dispatch", "tag tag-topic"));
        label.position.set(0, 15, 0);
        group.add(label);
        
        group.position.set(0, 40, 0);
        scene.add(group);
        return group;
    }

    function createLabel(text, className = "tag") {
        const div = document.createElement('div');
        div.className = className;
        div.textContent = text;
        return div;
    }

    function addLog(msg) {
        const panel = document.getElementById('log-panel');
        const div = document.createElement('div');
        div.className = 'log-card';
        div.innerHTML = `<strong>[Kafka Expert]</strong><br>${msg}`;
        panel.prepend(div);
        if(panel.childNodes.length > 8) panel.lastChild.remove();
    }

    // --- ä¸šåŠ¡é€»è¾‘ ---

    async function startCluster() {
        document.getElementById('btn-init').disabled = true;
        addLog("æ­£åœ¨å¯åŠ¨é›†ç¾¤å…ƒæ•°æ®ç®¡ç†å™¨...");
        
        topicCenter = createTopicCenter();
        await new Promise(r => setTimeout(r, 800));

        addLog("æ­£åœ¨å»ºç«‹ç‰©ç† Broker èŠ‚ç‚¹å¹¶æ³¨å†Œ ISR é›†åˆ...");
        for(let i=0; i<3; i++) {
            const b = createBrokerRack(i, new THREE.Vector3(-60 + i*60, 12, -30));
            brokers.push(b);
            // ç®¡é“ï¼šTopic -> Broker
            createTubeCable(topicCenter.position, b.group.position);
            await new Promise(r => setTimeout(r, 400));
        }

        // åˆ†åŒºå‰¯æœ¬å¸ƒå±€
        const config = [
            {bid: 0, pid: 0, type: 'leader'}, {bid: 1, pid: 0, type: 'follower'},
            {bid: 1, pid: 1, type: 'leader'}, {bid: 2, pid: 1, type: 'follower'},
            {bid: 2, pid: 2, type: 'leader'}, {bid: 0, pid: 2, type: 'follower'}
        ];

        config.forEach(c => {
            const pGeo = new THREE.BoxGeometry(6, 3, 6);
            const pMat = new THREE.MeshStandardMaterial({color: c.type === 'leader' ? COLORS.leader : COLORS.follower, emissive: c.type === 'leader' ? COLORS.leader : COLORS.follower, emissiveIntensity: 0.3});
            const pMesh = new THREE.Mesh(pGeo, pMat);
            pMesh.position.set(0, c.type === 'leader' ? 5 : -5, 8);
            brokers[c.bid].group.add(pMesh);
            pMesh.add(new CSS2DObject(createLabel(`P-${c.pid} ${c.type.toUpperCase()}`, c.type==='leader'?'tag tag-leader':'tag')));
            partitions.push({mesh: pMesh, ...c});
        });

        producerPC = createPCWorkstation("æ”¯ä»˜ä¸Šæ¸¸-ç”Ÿäº§è€…", "#39ff14", new THREE.Vector3(-100, 5, 80));
        consumerPC = createPCWorkstation("ç»“ç®—ä¸‹æ¸¸-æ¶ˆè´¹è€…ç»„", "#00d2ff", new THREE.Vector3(100, 5, 80));
        
        // ç‰©ç†è¿çº¿
        createTubeCable(producerPC.position, topicCenter.position);
        createTubeCable(topicCenter.position, consumerPC.position);

        addLog("é›†ç¾¤å·²å°±ç»ªã€‚æ‰€æœ‰ç®¡é“å·²é€šç”µï¼Œè´Ÿè½½å‡è¡¡é€»è¾‘å·²è½½å…¥ã€‚");
        document.getElementById('btn-produce').disabled = false;
        document.getElementById('btn-consume').disabled = false;
    }

    function producePigeon() {
        addLog("ç”Ÿäº§è€…ï¼šè§¦å‘é£é¸½ä¼ ä¹¦ï¼Œå°†æ¶ˆæ¯å°è£…å¹¶å‘é€è‡³ Topic è°ƒåº¦ä¸­å¿ƒã€‚");
        const pigeon = createPigeon();
        pigeon.position.copy(producerPC.position);
        scene.add(pigeon);

        // ç¬¬ä¸€æ­¥ï¼šé£å‘ Topic
        new TWEEN.Tween(pigeon.position).to({x:0, y:40, z:0}, 1000).easing(TWEEN.Easing.Quadratic.Out).onComplete(() => {
            addLog("Topic Centerï¼šæ ¹æ®åˆ†åŒºç­–ç•¥(RoundRobin) æ´¾å‘é£é¸½è‡³ Broker Leaderã€‚");
            
            const leaders = partitions.filter(p => p.type === 'leader');
            const target = leaders[Math.floor(Math.random()*leaders.length)];
            const targetPos = new THREE.Vector3();
            target.mesh.getWorldPosition(targetPos);

            // ç¬¬äºŒæ­¥ï¼šé£å‘ Broker Leader
            new TWEEN.Tween(pigeon.position).to({x: targetPos.x, y: targetPos.y, z: targetPos.z}, 1000).onComplete(() => {
                addLog(`Broker-${target.bid}ï¼šæ¶ˆæ¯è½ç›˜æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥ ISR å‰¯æœ¬ã€‚`);
                scene.remove(pigeon);
            }).start();
        }).start();
    }

    function consumeData() {
        addLog("æ¶ˆè´¹è€…ï¼šå‘èµ· Long Pollingï¼Œå‘ Topic è¯·æ±‚æœ€æ–°åç§»é‡æ•°æ®ã€‚");
        const target = partitions.find(p => p.type === 'leader');
        const startPos = new THREE.Vector3();
        target.mesh.getWorldPosition(startPos);
        
        const pigeon = createPigeon();
        pigeon.position.copy(startPos);
        scene.add(pigeon);

        new TWEEN.Tween(pigeon.position).to({x: consumerPC.position.x, y: 5, z: consumerPC.position.z}, 1500).onComplete(() => {
            addLog("æ¶ˆè´¹è€…ï¼šæˆåŠŸè·å–æ•°æ®åŒ…ï¼ŒCommit Offset å·²å®Œæˆã€‚");
            scene.remove(pigeon);
        }).start();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);
        if(topicCenter) topicCenter.rotation.y += 0.01;
        controls.update();
        renderer.render(scene, camera);
        labelRenderer.render(scene, camera);
    }

    init();
    document.getElementById('btn-init').onclick = startCluster;
    document.getElementById('btn-produce').onclick = producePigeon;
    document.getElementById('btn-consume').onclick = consumeData;
    document.getElementById('btn-reset').onclick = () => location.reload();

</script>
</body>
</html>