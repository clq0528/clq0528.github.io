<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Modbus RTU ä¸“å®¶çº§å…¨é“¾è·¯é€»è¾‘æ§åˆ¶å°</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --border: #30363d;
            --plc-blue: #005fb8;
            --slave-cyan: #0891b2;
            --text: #c9d1d9;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-gold: #d29922;
            --highlight: #58a6ff;
            --bin-on: #238636;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', 'Cascadia Code', monospace;
            margin: 0;
            display: grid;
            grid-template-columns: 450px 1fr 450px;
            grid-template-rows: 70px 1fr 280px;
            height: 100vh;
            gap: 8px;
            padding: 8px;
            overflow: hidden;
        }

        /* é€šç”¨åŒºå—æ ·å¼ */
        .box { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
        .box-title { background: rgba(255,255,255,0.05); padding: 8px 12px; font-weight: bold; font-size: 13px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }

        /* é¡¶éƒ¨ï¼šä¸Šå¸è§†è§’çš„æŒä¹…åŒ–è§£è¯´ */
        .header { grid-column: 1 / 4; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid var(--highlight); }
        .god-log { grid-column: 2; grid-row: 3; background: #000; padding: 10px; overflow-y: auto; font-size: 13px; border-left: 3px solid var(--accent-gold); }
        .god-log b { color: var(--accent-gold); display: block; margin-top: 5px; border-top: 1px solid #333; }

        /* å·¦ä¾§ï¼šä¸»ç«™æ§åˆ¶ä¸D8120ä½è§£æ */
        .master-panel { grid-row: 2; }
        .bit-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; padding: 10px; background: #000; }
        .bit-box { font-size: 9px; text-align: center; border: 1px solid #333; padding: 4px 0; }
        .bit-box.active { background: var(--bin-on); color: white; border-color: var(--accent-green); }
        
        /* æŠ¥æ–‡æµè½¬åŒº */
        .comm-wire { grid-row: 2; position: relative; background: radial-gradient(circle at center, #111 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bus-line { width: 80%; height: 4px; background: #444; position: relative; }
        .packet { position: absolute; padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 12px; white-space: nowrap; z-index: 50; display: none; }
        .packet.tx { background: var(--highlight); color: #000; }
        .packet.rx { background: var(--accent-green); color: #000; }

        /* å³ä¾§ï¼šä»ç«™ä¸Modbusæ‰‹å†Œå¯¹ç…§ */
        .slave-panel { grid-row: 2; }
        .protocol-ref { font-size: 11px; background: #1c2128; padding: 8px; margin: 10px; border-radius: 4px; border-left: 3px solid var(--slave-cyan); }
        .dynamic-table { width: 95%; margin: 10px auto; border-collapse: collapse; font-size: 12px; }
        .dynamic-table th, .dynamic-table td { border: 1px solid #333; padding: 6px; text-align: center; }
        .val-change { animation: highlight-pulse 1s; }
        @keyframes highlight-pulse { from { background: var(--bin-on); } to { background: transparent; } }

        /* åº•éƒ¨å®éªŒå®¤ */
        .lab-left { grid-column: 1; grid-row: 3; padding: 10px; }
        .lab-right { grid-column: 3; grid-row: 3; padding: 10px; }

        /* æŒ‰é’®ä¸çŠ¶æ€ */
        .status-led { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #333; }
        .led-on { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .led-busy { background: var(--accent-gold); box-shadow: 0 0 8px var(--accent-gold); }

        /* FBå— */
        .fb-block { border: 2px solid var(--plc-blue); margin: 10px; border-radius: 4px; font-size: 11px; }
        .fb-head { background: var(--plc-blue); padding: 4px; text-align: center; }
        .fb-io { display: flex; justify-content: space-between; padding: 8px; }
    </style>
</head>
<body>

<div class="header box">
    <div style="font-size: 20px;">ğŸ­ Modbus RTU å·¥ä¸šçº§åè®®ä»¿çœŸæ§åˆ¶å° (V2.0)</div>
    <div>ç³»ç»Ÿé¢‘ç‡: <span style="color:var(--accent-green)">PLC Scan 12ms</span></div>
</div>

<!-- å·¦ä¾§ï¼šPLCä¸»ç«™é€»è¾‘ -->
<div class="box master-panel">
    <div class="box-title">ä¸‰è± FX3U ä¸»ç«™å±‚ <span>ID: 00 (Master)</span></div>
    
    <!-- D8120 ä½è§£æ -->
    <div style="padding: 10px; font-size: 12px;">D8120 é€šä¿¡æ ¼å¼ä½è§£æ (Hex: <span id="h8120-val" style="color:var(--accent-gold)">0C81</span>)</div>
    <div class="bit-grid" id="d8120-grid">
        <!-- è‡ªåŠ¨ç”Ÿæˆ16ä¸ªä½ -->
    </div>
    <div style="font-size: 10px; padding: 0 10px; color: #888;">è§£æ: 9600bps | 8-N-1 | RS-485 | æ— åè®®æ§åˆ¶</div>

    <!-- FBå— -->
    <div class="fb-block">
        <div class="fb-head">MODBUS_RTU_MASTER [FB100]</div>
        <div class="fb-io">
            <div>
                <div>EN <span id="led-en" class="status-led"></span></div>
                <div>REQ <span id="led-req" class="status-led"></span></div>
                <div>ADDR: 1</div>
                <div>RW: 0 (Read)</div>
            </div>
            <div style="text-align: right;">
                <div><span id="led-done" class="status-led"></span> DONE</div>
                <div><span id="led-busy" class="status-led"></span> BUSY</div>
                <div><span id="led-error" class="status-led"></span> ERROR</div>
                <div><span id="val-output" style="color:var(--highlight)">-</span> DATA</div>
            </div>
        </div>
    </div>

    <!-- è½¬æ¢å®éªŒå®¤ -->
    <div class="lab-left">
        <div style="font-size: 12px; color: var(--accent-gold); margin-bottom: 5px;">å®æ—¶è½¬æ¢å™¨ (Hex â†” Binary)</div>
        <div id="convert-view" style="font-family: monospace; background: #000; padding: 10px; border-radius: 4px; font-size: 14px;">
            HEX: 04D2 <br>
            BIN: 0000 0100 1101 0010
        </div>
    </div>
</div>

<!-- ä¸­é—´ï¼šé€šä¿¡é“¾è·¯ä¸ä¸Šå¸è§£è¯´ -->
<div class="comm-wire box">
    <div class="box-title" style="width: 100%;">ç‰©ç†é“¾è·¯ & åè®®æµè½¬ (RS-485 åŠåŒå·¥)</div>
    
    <div class="bus-line">
        <div id="packet-obj" class="packet"></div>
    </div>

    <div style="margin-top: 50px; text-align: center; font-size: 12px; color: #666;">
        [åŒç»çº¿ A/B] ä¿¡å·ç”µå‹: <span id="bus-volt">0V</span>
    </div>

    <!-- æŒä¹…åŒ–ä¸Šå¸è§†è§’ -->
    <div class="god-log" id="god-log">
        <b>[ç³»ç»Ÿå°±ç»ª]</b>
        ä¸Šå¸è§†è§’å·²å¼€å¯ã€‚Modbus RTU æ˜¯â€œä¸»ä»ç»“æ„â€ï¼šä»ç«™æ°¸è¿œä¸èƒ½ä¸»åŠ¨å‘æ•°æ®ï¼Œå¿…é¡»ç”±ä¸»ç«™å…ˆå‘èµ·è¯¢é—®æŠ¥æ–‡ï¼Œä»ç«™åœ¨ 10ms-200ms å†…å“åº”å›å¤ã€‚
    </div>
</div>

<!-- å³ä¾§ï¼šä»ç«™è®¾å¤‡ -->
<div class="box slave-panel">
    <div class="box-title">æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ (ä»ç«™ ID: 01) <span>åè®®ç‰ˆ V1.2</span></div>
    
    <div class="protocol-ref">
        <b>Modbus å¯„å­˜å™¨æ‰‹å†Œå¯¹ç…§ (ä»ç«™):</b><br>
        â€¢ 40001 (0x0000): æ¸©åº¦ (å•ä½ 0.1â„ƒ)<br>
        â€¢ 40002 (0x0001): æ¹¿åº¦ (å•ä½ 0.1%RH)<br>
        â€¢ 40003 (0x0002): è®¾å¤‡ç”µå‹ (mV)
    </div>

    <table class="dynamic-table">
        <tr style="background: #222;"><th>åœ°å€(Hex)</th><th>å®šä¹‰</th><th>å®æ—¶æ•°æ®</th><th>16ä½äºŒè¿›åˆ¶</th></tr>
        <tr id="row-40001"><td>0000</td><td>æ¸©åº¦</td><td class="val-cell">25.0</td><td class="bin-cell">...</td></tr>
        <tr id="row-40002"><td>0001</td><td>æ¹¿åº¦</td><td class="val-cell">45.2</td><td class="bin-cell">...</td></tr>
        <tr id="row-40003"><td>0002</td><td>ç”µå‹</td><td class="val-cell">3300</td><td class="bin-cell">...</td></tr>
    </table>

    <div class="lab-right">
        <div style="color: var(--accent-gold); font-size: 12px; margin-bottom: 5px;">CRC-16 æ ¡éªŒéªŒè¯ (é«˜ä½ä½äº¤æ¢)</div>
        <div id="crc-view" style="font-family: monospace; background: #000; padding: 10px; border-radius: 4px; font-size: 11px; line-height: 1.4;">
            TX Data: [01 03 00 00 00 01]<br>
            Calculated CRC: 0x840A<br>
            <span style="color:var(--accent-green)">Match! Packet is valid.</span>
        </div>
    </div>
</div>

<script>
    const d8120Grid = document.getElementById('d8120-grid');
    const godLog = document.getElementById('god-log');
    const packetObj = document.getElementById('packet-obj');
    const busVolt = document.getElementById('bus-volt');

    // åˆå§‹åŒ– D8120 16ä½æ˜¾ç¤º
    const d8120Config = "0000110010000001"; // H0C81
    for(let i=15; i>=0; i--) {
        const bit = document.createElement('div');
        bit.className = `bit-box ${d8120Config[15-i] === '1' ? 'active' : ''}`;
        bit.innerHTML = `b${i}<br>${d8120Config[15-i]}`;
        d8120Grid.appendChild(bit);
    }

    // æ¨¡æ‹Ÿæ•°æ®æº
    let sensorData = { temp: 250, humi: 452, volt: 3300 };
    let pollIndex = 0; // è½®è¯¢ç´¢å¼•

    function addGodMsg(title, msg) {
        const div = document.createElement('div');
        div.innerHTML = `<b>[${title}]</b> ${msg}`;
        godLog.appendChild(div);
        godLog.scrollTop = godLog.scrollHeight;
        if(godLog.childNodes.length > 15) godLog.removeChild(godLog.childNodes[0]);
    }

    function toBin16(val) {
        return val.toString(2).padStart(16, '0').replace(/(.{4})/g, '$1 ');
    }

    async function communicationCycle() {
        // 1. ä»ç«™æ•°æ®æ³¢åŠ¨
        sensorData.temp += Math.floor(Math.random() * 3 - 1);
        sensorData.humi += Math.floor(Math.random() * 5 - 2);
        updateSlaveUI();

        // 2. ä¸»ç«™å‡†å¤‡è¯·æ±‚
        document.getElementById('led-en').classList.add('led-on');
        document.getElementById('led-req').classList.add('led-on');
        const pollTargets = [
            {addr: '00 00', name: 'æ¸©åº¦', hex: sensorData.temp.toString(16).toUpperCase().padStart(4, '0')},
            {addr: '00 01', name: 'æ¹¿åº¦', hex: sensorData.humi.toString(16).toUpperCase().padStart(4, '0')},
            {addr: '00 02', name: 'ç”µå‹', hex: sensorData.volt.toString(16).toUpperCase().padStart(4, '0')}
        ];
        const target = pollTargets[pollIndex % 3];
        addGodMsg("ä¸»ç«™å‘èµ·è½®è¯¢", `å½“å‰æ­£åœ¨è¯»å–ï¼š${target.name} (å¯„å­˜å™¨åœ°å€: ${target.addr})ã€‚FBå—æ­£åœ¨ç»„è£…æŠ¥æ–‡...`);

        // 3. å‘é€ TX
        await animatePacket(`TX: 01 03 ${target.addr} 00 01 [CRC]`, 'tx', 'left');
        busVolt.innerText = "+5V / -5V (Diff)";

        // 4. ä»ç«™å¤„ç†
        addGodMsg("ä»ç«™å“åº”", `ID:01 ä¾¦å¬åˆ°æ€»çº¿æ´»åŠ¨ã€‚è§£æåŠŸèƒ½ç  03 (è¯»)ï¼Œä»åœ°å€ ${target.addr} æå–æ•°æ® ${target.hex}Hã€‚`);
        
        // 5. è¿”å› RX
        await animatePacket(`RX: 01 03 02 ${target.hex.substring(0,2)} ${target.hex.substring(2,4)} [CRC]`, 'rx', 'right');
        
        // 6. ä¸»ç«™ä¿å­˜æ•°æ®
        document.getElementById('led-busy').classList.remove('led-busy');
        document.getElementById('led-done').classList.add('led-on');
        document.getElementById('val-output').innerText = (target.name === 'ç”µå‹' ? parseInt(target.hex, 16) : parseInt(target.hex, 16)/10);
        addGodMsg("æ•°æ®åŒæ­¥å®Œæˆ", `ä¸»ç«™å·²å°†åå…­è¿›åˆ¶ ${target.hex}H è½¬æ¢ä¸ºç‰©ç†å€¼å¹¶å­˜å…¥å¯„å­˜å™¨ã€‚é€šä¿¡é“¾è·¯é‡Šæ”¾ã€‚`);

        setTimeout(() => {
            document.getElementById('led-done').classList.remove('led-on');
            document.getElementById('led-req').classList.remove('led-on');
            pollIndex++;
            communicationCycle();
        }, 2000);
    }

    function animatePacket(text, type, direction) {
        return new Promise(resolve => {
            packetObj.innerText = text;
            packetObj.className = `packet ${type}`;
            packetObj.style.display = 'block';
            packetObj.style.left = direction === 'left' ? '10%' : '70%';
            
            let start = direction === 'left' ? 10 : 70;
            let end = direction === 'left' ? 70 : 10;
            let current = start;
            let step = direction === 'left' ? 2 : -2;

            let anim = setInterval(() => {
                current += step;
                packetObj.style.left = current + '%';
                if((step > 0 && current >= end) || (step < 0 && current <= end)) {
                    clearInterval(anim);
                    packetObj.style.display = 'none';
                    resolve();
                }
            }, 30);
        });
    }

    function updateSlaveUI() {
        const r1 = document.getElementById('row-40001');
        r1.cells[2].innerText = (sensorData.temp / 10).toFixed(1);
        r1.cells[3].innerText = toBin16(sensorData.temp);
        
        const r2 = document.getElementById('row-40002');
        r2.cells[2].innerText = (sensorData.humi / 10).toFixed(1);
        r2.cells[3].innerText = toBin16(sensorData.humi);

        const r3 = document.getElementById('row-40003');
        r3.cells[2].innerText = sensorData.volt;
        r3.cells[3].innerText = toBin16(sensorData.volt);

        document.getElementById('convert-view').innerHTML = `HEX: ${sensorData.temp.toString(16).toUpperCase().padStart(4, '0')} <br> BIN: ${toBin16(sensorData.temp)}`;
    }

    // å¯åŠ¨ç³»ç»Ÿ
    communicationCycle();
</script>
</body>
</html>