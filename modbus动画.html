<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Modbus RTU æ·±åº¦äº¤äº’ä»¿çœŸæ§åˆ¶å° - æŒæ§ç‰ˆ</title>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --border: #30363d;
            --plc-blue: #005fb8; --slave-cyan: #0891b2; --text: #c9d1d9;
            --accent-green: #3fb950; --accent-red: #f85149; --accent-gold: #d29922;
            --highlight: #58a6ff; --bin-on: #238636;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', monospace; margin: 0;
            display: grid; grid-template-columns: 420px 1fr 420px;
            grid-template-rows: 80px 1fr 260px; height: 100vh;
            gap: 10px; padding: 10px; overflow: hidden;
        }

        .box { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .box-title { background: rgba(255,255,255,0.05); padding: 10px; font-weight: bold; border-bottom: 1px solid var(--border); color: var(--highlight); display: flex; justify-content: space-between; }

        /* æ§åˆ¶ä¸­å¿ƒ */
        .header { grid-column: 1 / 4; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: linear-gradient(90deg, #161b22 0%, #0d419d 50%, #161b22 100%); border-bottom: 2px solid var(--highlight); }
        .controller { display: flex; gap: 10px; }
        button { background: var(--highlight); border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; color: #000; transition: 0.2s; }
        button:hover { background: var(--accent-green); }
        button:disabled { background: #444; cursor: not-allowed; }

        /* å·¦ä¾§ï¼šPLC */
        .bit-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; padding: 10px; }
        .bit-box { font-size: 10px; text-align: center; border: 1px solid #333; padding: 5px 0; background: #000; transition: 0.3s; }
        .bit-box.active { background: var(--bin-on); color: white; box-shadow: inset 0 0 5px #fff; }

        /* FBå— */
        .fb-block { border: 2px solid var(--plc-blue); margin: 15px; border-radius: 4px; background: #000; }
        .fb-io { display: flex; justify-content: space-between; padding: 10px; font-size: 12px; line-height: 1.8; }
        .led { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #333; margin: 0 5px; }
        .led.on { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }

        /* ä¸­é—´ï¼šé“¾è·¯ä¸è§£è¯´ */
        .center-stage { position: relative; display: flex; flex-direction: column; }
        .step-info { background: #000; border: 1px solid var(--accent-gold); margin: 15px; padding: 15px; border-radius: 6px; min-height: 100px; }
        .step-title { color: var(--accent-gold); font-weight: bold; margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid #333; }
        .packet-display { display: flex; justify-content: center; gap: 8px; margin-top: 40px; }
        .byte-unit { border: 1px solid var(--border); padding: 8px; text-align: center; background: #222; min-width: 40px; border-radius: 4px; position: relative; }
        .byte-unit.active { border-color: var(--highlight); background: #0d419d; transform: scale(1.1); }
        .byte-label { font-size: 10px; color: #888; margin-top: 5px; }

        /* å³ä¾§ï¼šä»ç«™ */
        .slave-table { width: 90%; margin: 10px auto; border-collapse: collapse; font-size: 12px; }
        .slave-table td, .slave-table th { border: 1px solid #333; padding: 8px; text-align: center; }
        .reg-input { width: 50px; background: #000; color: var(--accent-green); border: 1px solid #444; text-align: center; }

        /* åº•éƒ¨æ—¥å¿— */
        .bottom-log { grid-column: 1 / 3; background: #000; padding: 15px; overflow-y: auto; border-top: 1px solid var(--border); }
        .log-line { margin-bottom: 5px; font-size: 13px; border-left: 2px solid #444; padding-left: 10px; }
        .log-master { border-color: var(--highlight); }
        .log-slave { border-color: var(--slave-cyan); }
        .log-god { border-color: var(--accent-gold); color: var(--accent-gold); font-style: italic; }

        /* è½¬æ¢å®éªŒå®¤ */
        .converter { grid-column: 3; background: #000; padding: 15px; border-top: 1px solid var(--border); font-size: 12px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 18px; font-weight: bold;">MODBUS RTU å…¨é“¾è·¯é€»è¾‘æŒæ§å°</div>
    <div class="controller">
        <button id="btn-next" onclick="nextStep()">â–¶ ä¸‹ä¸€æ­¥ (Next Step)</button>
        <button id="btn-reset" onclick="resetSim()" style="background: var(--accent-red);">â†º é‡ç½®</button>
    </div>
    <div id="cycle-pos">æ­¥éª¤: 0 / 8</div>
</div>

<!-- å·¦ä¾§ï¼šPLC ä¸»ç«™ -->
<div class="box">
    <div class="box-title">ä¸‰è± FX3U ä¸»ç«™ <span>(D8120 é…ç½®ä¸­å¿ƒ)</span></div>
    <div class="bit-grid" id="d8120-bits"></div>
    <div style="padding: 0 15px; font-size: 11px; color: #888;">
        D8120: <span id="hex-8120" style="color:var(--accent-gold)">H0C81</span> | 9600-8-N-1
    </div>

    <div class="fb-block">
        <div style="background: var(--plc-blue); padding: 5px; font-size: 12px; text-align: center;">ADPRW (MODBUS Master FB)</div>
        <div class="fb-io">
            <div>
                <span class="led" id="led-en"></span> EN (ä½¿èƒ½)<br>
                <span class="led" id="led-req"></span> REQ (è¯·æ±‚)<br>
                S1: 1 (ç«™å·)<br>
                S2: 03 (åŠŸèƒ½ç )<br>
                S3: 0 (åœ°å€)
            </div>
            <div style="text-align: right;">
                DONE <span class="led" id="led-done"></span><br>
                BUSY <span class="led" id="led-busy"></span><br>
                ERR <span class="led" id="led-err"></span><br>
                D-OUT: <span id="master-val" style="color:var(--highlight)">0</span>
            </div>
        </div>
    </div>
</div>

<!-- ä¸­é—´ï¼šæ ¸å¿ƒé“¾è·¯ä¸è§£è¯´ -->
<div class="box center-stage">
    <div class="step-info">
        <div class="step-title" id="step-title">ç­‰å¾…æ“ä½œ...</div>
        <div id="step-desc" style="font-size: 14px; line-height: 1.5;">è¯·ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹ä¸€ä¸ªå®Œæ•´çš„ Modbus é€šä¿¡å‘¨æœŸã€‚</div>
    </div>

    <div class="packet-display" id="packet-box">
        <!-- åŠ¨æ€ç”ŸæˆæŠ¥æ–‡ -->
    </div>

    <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; color: #444; font-size: 12px;">
        æ•°æ®é“¾è·¯å±‚: RS-485 åŠåŒå·¥ | ç‰©ç†æ³¢å½¢: å·®åˆ†ç”µå¹³
    </div>
</div>

<!-- å³ä¾§ï¼šä»ç«™è®¾å¤‡ -->
<div class="box">
    <div class="box-title">ä»ç«™ä»ªè¡¨ (ID: 01) <span>(å¯æ‰‹åŠ¨ä¿®æ”¹æ•°æ®)</span></div>
    <div style="padding: 10px; font-size: 11px; background: #111; margin: 10px; border-radius: 4px; color: var(--slave-cyan);">
        MODBUS æ‰‹å†Œå¯¹ç…§ï¼š<br>
        â€¢ åœ°å€ 0000H -> å¯„å­˜å™¨ 40001 (æ¸©åº¦)<br>
        â€¢ èŒƒå›´: -40.0 ~ 120.0 â„ƒ (ç¼©æ”¾ 10 å€)
    </div>

    <table class="slave-table">
        <tr style="background: #222;"><th>å¯„å­˜å™¨</th><th>æè¿°</th><th>ç‰©ç†å€¼</th><th>Hexæ•°æ®</th></tr>
        <tr>
            <td>0000H</td><td>æ¸©åº¦</td>
            <td><input type="number" id="s-temp" class="reg-input" value="25.5" step="0.1"> â„ƒ</td>
            <td id="s-temp-hex">00FF</td>
        </tr>
    </table>

    <div style="margin-top: auto; padding: 15px; border-top: 1px solid #333;">
        <div style="font-size: 12px; color: var(--accent-gold);">ä»ç«™å†…éƒ¨é€»è¾‘ï¼š</div>
        <div id="slave-log" style="font-size: 11px; font-family: monospace; color: #888;">ç›‘å¬ä¸­...</div>
    </div>
</div>

<!-- åº•éƒ¨ï¼šæ—¥å¿—ä¸å®éªŒå®¤ -->
<div class="box bottom-log" id="log-stack">
    <div class="log-line log-god">ä¸Šå¸è§†è§’ï¼šç³»ç»Ÿåˆå§‹åŒ–ã€‚Modbus RTU é€šä¿¡å¿…é¡»ç”±ä¸»ç«™å‘èµ·ï¼Œä»ç«™ä¸¥ç¦ä¸»åŠ¨å‡ºå£°ã€‚</div>
</div>

<div class="box converter">
    <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 5px;">CRC-16 æ ¡éªŒå®éªŒå®¤</div>
    <div id="crc-lab" style="font-family: monospace; line-height: 1.4; color: #aaa;">
        ç­‰å¾…æŠ¥æ–‡ç»„è£…...
    </div>
</div>

<script>
    let currentStep = 0;
    const totalSteps = 8;
    const d8120Config = "0000110010000001"; // H0C81

    // åˆå§‹åŒ– D8120 ä½
    const grid = document.getElementById('d8120-bits');
    for(let i=15; i>=0; i--) {
        const div = document.createElement('div');
        div.className = `bit-box ${d8120Config[15-i] === '1' ? 'active' : ''}`;
        div.innerHTML = `b${i}<br>${d8120Config[15-i]}`;
        div.id = `bit-${i}`;
        grid.appendChild(div);
    }

    function addLog(msg, type='god') {
        const div = document.createElement('div');
        div.className = `log-line log-${type}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        const stack = document.getElementById('log-stack');
        stack.appendChild(div);
        stack.scrollTop = stack.scrollHeight;
    }

    function updatePacket(bytes, labels) {
        const box = document.getElementById('packet-box');
        box.innerHTML = '';
        bytes.forEach((b, i) => {
            box.innerHTML += `
                <div class="byte-unit">
                    <div style="font-size:18px; font-weight:bold;">${b}</div>
                    <div class="byte-label">${labels[i]}</div>
                </div>
            `;
        });
    }

    function resetSim() {
        currentStep = 0;
        document.getElementById('cycle-pos').innerText = `æ­¥éª¤: 0 / 8`;
        document.getElementById('step-title').innerText = "ç­‰å¾…æ“ä½œ...";
        document.getElementById('step-desc').innerText = "è¯·ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹ä¸€ä¸ªå®Œæ•´çš„ Modbus é€šä¿¡å‘¨æœŸã€‚";
        document.getElementById('packet-box').innerHTML = '';
        document.getElementById('led-en').classList.remove('on');
        document.getElementById('led-req').classList.remove('on');
        document.getElementById('led-busy').classList.remove('on');
        document.getElementById('led-done').classList.remove('on');
        document.getElementById('master-val').innerText = '0';
        addLog("ç³»ç»Ÿå·²é‡ç½®ã€‚");
    }

    function nextStep() {
        currentStep++;
        if(currentStep > totalSteps) { resetSim(); return; }
        document.getElementById('cycle-pos').innerText = `æ­¥éª¤: ${currentStep} / 8`;

        switch(currentStep) {
            case 1:
                document.getElementById('led-en').classList.add('on');
                document.getElementById('step-title').innerText = "1. PLC æ‰«æé€»è¾‘è§¦å‘";
                document.getElementById('step-desc').innerText = "ç”¨æˆ·æ‹¨åŠ¨å¼€å…³ M0ï¼ŒPLC æ‰§è¡Œåˆ° ADPRW æŒ‡ä»¤ã€‚CPU æ£€æŸ¥ D8120 ç¡®è®¤é€šä¿¡æ ¼å¼ï¼ˆ9600-8-N-1ï¼‰ã€‚";
                addLog("ä¸»ç«™ï¼šæ‰«æåˆ° ADPRW æŒ‡ä»¤ï¼Œä½¿èƒ½ç¯äº®èµ·ã€‚", "master");
                break;

            case 2:
                document.getElementById('led-req').classList.add('on');
                document.getElementById('led-busy').classList.add('on');
                document.getElementById('step-title').innerText = "2. FB å—å‚æ•°é”å®š";
                document.getElementById('step-desc').innerText = "FB å—è¯»å–è¾“å…¥å¼•è„šï¼šç«™å·=1ï¼ŒåŠŸèƒ½ç =03ï¼Œèµ·å§‹åœ°å€=0000Hï¼Œé•¿åº¦=1ã€‚å‡†å¤‡è¿›å…¥å‘é€ç¼“å­˜ã€‚";
                addLog("ä¸»ç«™ï¼šå‚æ•°å·²é”å®šï¼Œå‡†å¤‡è¿›è¡Œ CRC è®¡ç®—ã€‚", "master");
                break;

            case 3:
                document.getElementById('step-title').innerText = "3. CRC-16 æ ¡éªŒè®¡ç®—";
                document.getElementById('step-desc').innerText = "ä¸»ç«™å¯¹æ•°æ® [01 03 00 00 00 01] è¿›è¡Œå¤šé¡¹å¼å¼‚æˆ–è¿ç®—ã€‚";
                document.getElementById('crc-lab').innerHTML = "Init: FFFF <br> XOR 01 -> FFFE <br> ... <br> <span style='color:var(--accent-green)'>Result: 840A (Low-High Swap)</span>";
                updatePacket(['01','03','00','00','00','01','84','0A'], ['ID','CMD','AddrH','AddrL','NumH','NumL','CRCL','CRCH']);
                addLog("ä¸Šå¸è§†è§’ï¼šCRC æ˜¯ä¸ºäº†ç¡®ä¿ä¼ è¾“è¿‡ç¨‹ä¸­å¦‚æœ A/B çº¿å—åˆ°ç”µç£å¹²æ‰°ï¼Œæ•°æ®ä¸é”™ä¹±ã€‚", "god");
                break;

            case 4:
                document.getElementById('step-title').innerText = "4. è¯·æ±‚æŠ¥æ–‡åœ¨æ€»çº¿å¹¿æ’­";
                document.getElementById('step-desc').innerText = "æŠ¥æ–‡é€šè¿‡ RS-485 æ”¶å‘å™¨è½¬æ¢æˆå·®åˆ†ç”µå¹³ï¼Œå‘é€åˆ°åŒç»çº¿ä¸Šã€‚";
                addLog("ä¸»ç«™ï¼šTX -> 01 03 00 00 00 01 84 0A", "master");
                document.querySelectorAll('.byte-unit').forEach(el => el.classList.add('active'));
                break;

            case 5:
                document.getElementById('step-title').innerText = "5. ä»ç«™æ¥æ”¶å¹¶æ ¸å¯¹ ID";
                document.getElementById('step-desc').innerText = "ä»ç«™ 01 æ”¶åˆ°æ•°æ®ã€‚é¦–å…ˆæ£€æŸ¥ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å¦ä¸º 01ã€‚å¦‚æœæ˜¯ 02 æˆ–æ˜¯å…¶ä»–ï¼Œå®ƒå°†ä¿æŒæ²‰é»˜ã€‚";
                document.getElementById('slave-log').innerHTML = "ä¾¦æµ‹åˆ° 01 ç«™å·... åŒ¹é…æˆåŠŸ!<br>æ­£åœ¨æ‰§è¡Œ CRC æ ¡éªŒ...";
                addLog("ä»ç«™ï¼šæ”¶åˆ°æˆ‘çš„ç«™å·ï¼Œå‡†å¤‡å¤„ç†è¯·æ±‚ã€‚", "slave");
                break;

            case 6:
                const tempVal = parseFloat(document.getElementById('s-temp').value);
                const hexVal = (tempVal * 10).toString(16).toUpperCase().padStart(4, '0');
                document.getElementById('s-temp-hex').innerText = hexVal;
                document.getElementById('step-title').innerText = "6. ä»ç«™ç»„å»ºå“åº”æŠ¥æ–‡";
                document.getElementById('step-desc').innerText = `ä»ç«™æŸ¥è¯¢å†…å­˜ï¼šæ¸©åº¦ä¸º ${tempVal}â„ƒï¼Œå¯¹åº”åå…­è¿›åˆ¶ä¸º ${hexVal}Hã€‚å¼€å§‹ç»„å»ºå›å¤æŠ¥æ–‡ã€‚`;
                updatePacket(['01','03','02', hexVal.substring(0,2), hexVal.substring(2,4), 'CRC','CRC'], ['ID','CMD','Bytes','DataH','DataL','CRCL','CRCH']);
                addLog("ä»ç«™ï¼šå‡†å¤‡å‘é€æ•°æ® -> " + hexVal, "slave");
                break;

            case 7:
                document.getElementById('step-title').innerText = "7. æ•°æ®å›ä¼ ä¸»ç«™";
                document.getElementById('step-desc').innerText = "ä»ç«™æ§åˆ¶ A/B çº¿ç”µå¹³ï¼Œå°†åŒ…å«æ¸©æ•°æ®çš„æŠ¥æ–‡å‘å›ã€‚ä¸»ç«™ BUSY ç¯ä¿æŒå¸¸äº®ã€‚";
                addLog("ä»ç«™ï¼šRX -> 01 03 02 ...", "slave");
                break;

            case 8:
                const finalTemp = parseFloat(document.getElementById('s-temp').value);
                document.getElementById('master-val').innerText = finalTemp;
                document.getElementById('led-busy').classList.remove('on');
                document.getElementById('led-done').classList.add('on');
                document.getElementById('step-title').innerText = "8. ä¸»ç«™è§£ç ä¸èµ‹å€¼";
                document.getElementById('step-desc').innerText = "ä¸»ç«™éªŒè¯ä»ç«™å›ä¼ çš„ CRC æˆåŠŸï¼Œæå–æ•°æ®æ®µã€‚å°† 16 è¿›åˆ¶è½¬æ¢ä¸ºç‰©ç†å€¼ï¼Œå¹¶å­˜å…¥ D å¯„å­˜å™¨ã€‚æœ¬æ¬¡é€šä¿¡æˆåŠŸã€‚";
                addLog("ä¸»ç«™ï¼šæ•°æ®è¯»å–æˆåŠŸï¼Œå­˜å…¥æŒ‡å®š D åŒºåŸŸã€‚", "master");
                document.getElementById('btn-next').innerText = "ğŸ” é‡æ–°å¼€å§‹";
                break;
        }
    }
</script>
</body>
</html>