<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ºæœä¸‰ç¯æ§åˆ¶ä»¿çœŸç³»ç»Ÿ - æ•´åˆç‰ˆ</title>
    <!-- å¼•å…¥å…¬å…±ä¾èµ– -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* ========== æ–°å¢ Tab åˆ‡æ¢æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .tab-container {
            max-width: 100%;
            min-height: 100vh;
            background: #fdfdfd;
        }
        .tab-nav {
            display: flex;
            background: #2c3e50;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-nav-item {
            padding: 15px 30px;
            color: #ecf0f1;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-nav-item.active {
            background: #34495e;
            border-bottom: 3px solid #3498db;
            color: #fff;
        }
        .tab-nav-item:hover {
            background: #34495e;
        }
        .tab-content {
            width: 100%;
            min-height: calc(100vh - 62px);
        }
        .tab-panel {
            display: none;
            width: 100%;
            height: 100%;
        }
        .tab-panel.active {
            display: block;
        }

        /* ========== Tab1 åŸæœ‰æ ·å¼ (å®Œæ•´ä¿ç•™) ========== */
        #tab1-panel {
            background: #fdfdfd;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            color: #333;
            padding: 20px;
        }
        #tab1-panel .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }
        #tab1-panel .header {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        #tab1-panel .layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        #tab1-panel #jxgbox {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: white;
        }
        #tab1-panel .math-display {
            background: #f8f9fa;
            padding: 20px;
            border-left: 5px solid #0072b2;
            border-radius: 4px;
        }
        #tab1-panel .math-display h3 {
            margin-top: 0;
            font-size: 1rem;
            color: #0072b2;
        }
        #tab1-panel .control-panel {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #tab1-panel .param-row {
            margin: 15px 0;
        }
        #tab1-panel label {
            display: block;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #tab1-panel input[type="range"] {
            width: 100%;
        }
        #tab1-panel .val {
            color: #d55e00;
            font-family: monospace;
        }
        #tab1-panel .loop-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        #tab1-panel .highlight {
            font-weight: bold;
            color: #000;
        }
        #tab1-panel .math-notes {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #555;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
        }

        /* ========== Tab2 åŸæœ‰æ ·å¼ (å®Œæ•´ä¿ç•™) ========== */
        #tab2-panel {
            background: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            height: calc(100vh - 62px);
            overflow: hidden;
        }
        #tab2-panel .sidebar {
            width: 380px;
            background: #1e1e1e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            z-index: 10;
        }
        #tab2-panel h1 {
            font-size: 1.1rem;
            color: #00ffcc;
            border-bottom: 2px solid #00ffcc;
            padding-bottom: 10px;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }
        #tab2-panel h2 {
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-top: 20px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #tab2-panel h2::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #333;
        }
        #tab2-panel .param-group {
            background: #262626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }
        #tab2-panel label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin: 8px 0;
            font-weight: 500;
        }
        #tab2-panel input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: #00ffcc;
            margin-top: 5px;
        }
        #tab2-panel .val-display {
            color: #00ffcc;
            font-family: monospace;
            font-weight: bold;
        }
        #tab2-panel .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            position: relative;
        }
        #tab2-panel .expert-advice {
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid #00ffcc;
            border-radius: 8px;
            padding: 15px;
            min-height: 80px;
            transition: all 0.3s ease;
        }
        #tab2-panel .advice-title {
            color: #00ffcc;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #tab2-panel .advice-content {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #ccc;
        }
        #tab2-panel .motor-stage {
            height: 180px;
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid #333;
        }
        #tab2-panel .motor-shaft {
            width: 100px;
            height: 100px;
            border: 8px solid #444;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #tab2-panel .motor-shaft::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 50%;
            background: #00ffcc;
            top: 0;
            left: calc(50% - 3px);
            transform-origin: bottom center;
            box-shadow: 0 0 15px #00ffcc;
            border-radius: 3px;
        }
        #tab2-panel .motor-label {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-family: 'Courier New', monospace;
            color: #00ffcc;
            font-size: 0.9rem;
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 4px;
        }
        #tab2-panel .charts-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
        }
        #tab2-panel .chart-box {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #333;
        }
        #tab2-panel .tuning-steps {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 280px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            pointer-events: none;
        }
        #tab2-panel .step {
            margin-bottom: 8px;
            color: #888;
        }
        #tab2-panel .step.active {
            color: #00ffcc;
            font-weight: bold;
        }
        #tab2-panel button {
            background: #00ffcc;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
            margin-top: 10px;
            text-transform: uppercase;
        }
        #tab2-panel button:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }
        #tab2-panel .btn-reset {
            background: #ff4444;
            color: white;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="tab-container">
        <!-- Tab å¯¼èˆªæ  -->
        <div class="tab-nav">
            <div class="tab-nav-item active" data-tab="tab1">ä¼ºæœä¸‰ç¯åµŒå¥—æ§åˆ¶ï¼šæ•°å­¦æ¶æ„ä»¿çœŸ</div>
            <div class="tab-nav-item" data-tab="tab2">ä¸“å®¶çº§ä¼ºæœä¸‰ç¯ PID ä»¿çœŸæ•™å­¦ç³»ç»Ÿ</div>
        </div>

        <!-- Tab å†…å®¹åŒºåŸŸ -->
        <div class="tab-content">
            <!-- Tab1 é¢æ¿ (åŸæœ‰Tab1å®Œæ•´å†…å®¹) -->
            <div class="tab-panel active" id="tab1-panel">
                <div class="container">
                    <div class="header">
                        <h1>ä¼ºæœåµŒå¥—ä¸‰ç¯ (Cascade Control) æ•°å­¦æ¶æ„</h1>
                        <p>åŸºäº JSXGraph çš„åŠ¨æ€æ§åˆ¶æ¡†å›¾ä¸ç‰©ç†ä»¿çœŸ</p>
                    </div>

                    <div class="layout">
                        <!-- åŠ¨æ€æ¡†å›¾å±•ç¤º -->
                        <div id="jxgbox" class="jxgbox"></div>

                        <!-- ä¾§è¾¹å…¬å¼ä¸æ§åˆ¶ -->
                        <div class="side-bar">
                            <div class="math-display" id="math-output">
                                <h3>å½“å‰ä¼ é€’å‡½æ•°çŠ¶æ€</h3>
                                <div id="formula-pos">$$ \omega_{ref} = K_{p} \cdot ( \theta_{ref} - \theta ) $$</div>
                                <div id="formula-speed">$$ I_{ref} = K_{p} e_\omega + K_{i} \int e_\omega dt $$</div>
                                <div id="formula-torque">$$ V_{out} = K_{p} e_i + K_{i} \int e_i dt $$</div>
                            </div>

                            <div class="control-panel">
                                <div class="param-row">
                                    <label>ç›®æ ‡ä½ç½® Î¸_ref: <span class="val" id="v_target">0</span>Â°</label>
                                    <input type="range" id="target" min="-180" max="180" value="45">
                                </div>
                                <div class="param-row">
                                    <label>è´Ÿè½½è½¬çŸ© T_load: <span class="val" id="v_load">0</span> Nm</label>
                                    <input type="range" id="load" min="0" max="50" step="1" value="0">
                                </div>
                                <hr>
                                <div class="loop-desc">
                                    <p><span class="highlight">1. ä½ç½®ç¯ (P):</span> å¤–ç¯è®¡ç®—ä½ç½®è¯¯å·®ï¼Œè¾“å‡ºç›®æ ‡è½¬é€Ÿã€‚</p>
                                    <p><span class="highlight">2. é€Ÿåº¦ç¯ (PI):</span> ä¸­ç¯æŠµæŠ— <span style="color:red">T_load</span>ï¼ŒKi ç§¯åˆ†é¡¹è´Ÿè´£æ¶ˆé™¤é™å·®ã€‚</p>
                                    <p><span class="highlight">3. ç”µæµç¯ (PI):</span> å†…ç¯å“åº”æœ€å¿«ï¼Œç›´æ¥å†³å®šç£åœºè½¬çŸ©ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="math-notes">
                    <strong>ğŸ’¡ æ•°å­¦è¯´æ˜ï¼š</strong>
                    <ul>
                        <li><strong>å†…ç¯ (ç”µæµç¯):</strong> å®ƒçš„å¸¦å®½å¿…é¡»æœ€é«˜ï¼ˆé€šå¸¸æ˜¯é€Ÿåº¦ç¯çš„10å€ï¼‰ã€‚å®ƒå¤„ç†çš„æ˜¯ç”µå­¦æ–¹ç¨‹ \( V = IR + L\frac{di}{dt} + K_e\omega \)ã€‚</li>
                        <li><strong>ä¸­ç¯ (é€Ÿåº¦ç¯):</strong> å®ƒæ˜¯æœºæ¢°èƒ½çš„å®ˆæŠ¤è€…ã€‚å½“ä½ åœ¨æ»‘å—ä¸Šå¢åŠ  <strong>T_load</strong> æ—¶ï¼Œé€Ÿåº¦ä¼šç¬é—´ä¸‹é™ï¼Œæ­¤æ—¶ PI æ§åˆ¶å™¨ä¸­çš„ <strong>I (ç§¯åˆ†é¡¹)</strong> å¼€å§‹ç´¯ç§¯ï¼Œå¼ºåˆ¶å¢åŠ ç”µæµç¯çš„ç»™å®šå€¼ï¼Œç›´åˆ°ç”µæœºè½¬çŸ©èƒ½å¤ŸæŠµæ¶ˆè´Ÿè½½ï¼Œè½¬é€Ÿæ¢å¤å¹³è¡¡ã€‚</li>
                        <li><strong>å¤–ç¯ (ä½ç½®ç¯):</strong> å®ƒæ˜¯æŒ‡æŒ¥å®˜ã€‚å®ƒåªå…³å¿ƒ $\Delta\theta$ã€‚åœ¨ç°ä»£ä¼ºæœä¸­ï¼Œä½ç½®ç¯é€šå¸¸åªç”¨ P æ§åˆ¶ï¼Œå› ä¸ºç§¯åˆ†é¡¹æ”¾åœ¨å¤–ç¯å®¹æ˜“å¼•èµ·è¶…è°ƒå’Œä½é¢‘éœ‡è¡ã€‚</li>
                    </ul>
                </div>

                <script>
                    // ========== Tab1 åŸæœ‰è„šæœ¬ (å®Œæ•´ä¿ç•™ï¼Œå°è£…åœ¨IIFEä¸­é¿å…å†²çª) ==========
                    (function() {
                        // ================= åˆå§‹åŒ– JSXGraph ç”»æ¿ =================
                        const board = JXG.JSXGraph.initBoard('jxgbox', {
                            boundingbox: [-10, 10, 10, -10],
                            axis: false,
                            showCopyright: false,
                            pan: {enabled: false}
                        });

                        // ç»˜åˆ¶æ¡†å›¾ç»“æ„ (èƒŒæ™¯)
                        const posBox = board.create('polygon', [[-9,2], [-6,2], [-6,-2], [-9,-2]], {fillColor:'#e6f3ff', strokeColor:'#0072b2', fixed:true});
                        const spdBox = board.create('polygon', [[-5,2], [-2,2], [-2,-2], [-5,-2]], {fillColor:'#fff4e6', strokeColor:'#d55e00', fixed:true});
                        const curBox = board.create('polygon', [[-1,2], [2,2], [2,-2], [-1,-2]], {fillColor:'#f3e6ff', strokeColor:'#cc79a7', fixed:true});
                        const motorBox = board.create('polygon', [[4,3], [8,3], [8,-3], [4,-3]], {fillColor:'#eee', strokeColor:'#333', fixed:true});

                        board.create('text', [-8.8, 0, 'ä½ç½® P'], {fontSize:14});
                        board.create('text', [-4.8, 0, 'é€Ÿåº¦ PI'], {fontSize:14});
                        board.create('text', [-0.8, 0, 'ç”µæµ PI'], {fontSize:14});
                        board.create('text', [5, 0, 'ç”µæœº/è´Ÿè½½'], {fontSize:14});

                        // ç»˜åˆ¶ç‰©ç†åé¦ˆåŠ¨æ€åœ† (å³ä¾§æ¨¡æ‹Ÿç”µæœºè½¬åŠ¨)
                        const center = board.create('point', [6, -6], {visible:false});
                        const motorCircle = board.create('circle', [center, 3], {strokeColor: '#333', strokeWidth:2});
                        const shaftLine = board.create('segment', [center, [6, -3]], {strokeColor: '#d55e00', strokeWidth:5});
                        const targetPointer = board.create('segment', [center, [6, -3]], {strokeColor: '#0072b2', strokeWidth:2, dash:2});

                        // ç»˜åˆ¶è¯¯å·®åŠ¨æ€æŒ‡ç¤º (åŠ¨æ€ç®­å¤´ï¼Œè¡¨ç¤ºè¯¯å·®å¤§å°)
                        const errArrow = board.create('arrow', [[-9, 4], [-9, 4]], {strokeColor:'red', strokeWidth:3});

                        // ================= ä»¿çœŸæ ¸å¿ƒé€»è¾‘ =================
                        let state = {
                            pos: 0, speed: 0, current: 0,
                            target: 45, load: 0,
                            int_speed: 0, int_curr: 0
                        };

                        const params = {
                            kp_p: 2.0,
                            kp_s: 1.5, ki_s: 0.8,
                            kp_c: 5.0, ki_c: 2.0,
                            J: 0.5, R: 1.2, Kt: 1.0, dt: 0.02
                        };

                        function simulate() {
                            // 1. ä½ç½®ç¯ (Pæ§åˆ¶)
                            let error_p = (state.target - state.pos);
                            let targetSpeed = error_p * params.kp_p;

                            // 2. é€Ÿåº¦ç¯ (PIæ§åˆ¶)
                            let error_s = targetSpeed - state.speed;
                            state.int_speed += error_s * params.dt;
                            let targetCurr = (error_s * params.kp_s) + (state.int_speed * params.ki_s);

                            // 3. ç”µæµç¯ (PIæ§åˆ¶)
                            let error_c = targetCurr - state.current;
                            state.int_curr += error_c * params.dt;
                            let voltage = (error_c * params.kp_c) + (state.int_curr * params.ki_c);

                            // ç”µæœºç‰©ç†æ¨¡å‹
                            // è½¬çŸ© T = Kt * I; åŠ é€Ÿåº¦ a = (T - T_load) / J
                            state.current = voltage / params.R; // ç®€åŒ–ï¼šå¿½ç•¥ç”µæ„Ÿ L
                            let torque = params.Kt * state.current;
                            let accel = (torque - state.load) / params.J;
                            
                            state.speed += accel * params.dt;
                            state.pos += state.speed * params.dt;

                            // æ›´æ–° UI
                            updateVisuals(error_p);
                        }

                        function updateVisuals(error_p) {
                            // æ›´æ–°å³ä¾§ç”µæœºæ—‹è½¬ ( shaftLine )
                            let rad = state.pos * Math.PI / 180;
                            shaftLine.point2.setPosition(JXG.COORDS_BY_USER, [
                                6 + 3 * Math.sin(rad),
                                -6 + 3 * Math.cos(rad)
                            ]);

                            // æ›´æ–°ç›®æ ‡è™šçº¿æŒ‡é’ˆ
                            let tRad = state.target * Math.PI / 180;
                            targetPointer.point2.setPosition(JXG.COORDS_BY_USER, [
                                6 + 3 * Math.sin(tRad),
                                -6 + 3 * Math.cos(tRad)
                            ]);

                            // æ›´æ–°è¯¯å·®æŒ‡ç¤ºç®­å¤´ (ä½ç½®ç¯è¯¯å·®å¯è§†åŒ–)
                            // ç®­å¤´é•¿åº¦éš error_p å˜åŒ–
                            errArrow.point2.setPosition(JXG.COORDS_BY_USER, [-9 + error_p/10, 4]);

                            board.update();
                        }

                        // ================= äº¤äº’ç»‘å®š =================
                        document.getElementById('target').addEventListener('input', (e) => {
                            state.target = parseFloat(e.target.value);
                            document.getElementById('v_target').innerText = state.target;
                        });

                        document.getElementById('load').addEventListener('input', (e) => {
                            state.load = parseFloat(e.target.value);
                            document.getElementById('v_load').innerText = state.load;
                        });

                        // å¯åŠ¨ä¸»å¾ªç¯
                        setInterval(simulate, 20);
                    })();
                </script>
            </div>

            <!-- Tab2 é¢æ¿ (åŸæœ‰Tab2å®Œæ•´å†…å®¹) -->
            <div class="tab-panel" id="tab2-panel">
                <div class="sidebar">
                    <h1>SERVO EXPERT V2.0</h1>
                    
                    <div class="param-group">
                        <label>1. ç›®æ ‡ä½ç½® (Deg): <span class="val-display" id="v_targetPos">0</span></label>
                        <input type="range" id="targetPos" min="-1800" max="1800" value="0">
                        <label>è´Ÿè½½è½¬çŸ© (Nm): <span class="val-display" id="v_loadTorque">0</span></label>
                        <input type="range" id="loadTorque" min="0" max="15" step="0.1" value="0">
                    </div>

                    <h2>ä½ç½®ç¯ (Position - P)</h2>
                    <div class="param-group">
                        <label>Kp (ä½ç½®): <span class="val-display" id="v_kp_p">1.0</span></label>
                        <input type="range" id="kp_p" min="0" max="10" step="0.1" value="1.0">
                    </div>

                    <h2>é€Ÿåº¦ç¯ (Speed - PI)</h2>
                    <div class="param-group">
                        <label>Kp (é€Ÿåº¦): <span class="val-display" id="v_kp_s">0.5</span></label>
                        <input type="range" id="kp_s" min="0" max="5" step="0.01" value="0.5">
                        <label>Ki (é€Ÿåº¦): <span class="val-display" id="v_ki_s">0.1</span></label>
                        <input type="range" id="ki_s" min="0" max="5" step="0.01" value="0.1">
                    </div>

                    <h2>ç”µæµç¯ (Current - PI)</h2>
                    <div class="param-group">
                        <label>Kp (ç”µæµ): <span class="val-display" id="v_kp_c">2.0</span></label>
                        <input type="range" id="kp_c" min="0" max="20" step="0.1" value="2.0">
                        <label>Ki (ç”µæµ): <span class="val-display" id="v_ki_c">0.5</span></label>
                        <input type="range" id="ki_c" min="0" max="10" step="0.1" value="0.5">
                    </div>

                    <h2>ç”µæœºåŠ¨åŠ›å­¦ (Physics)</h2>
                    <div class="param-group">
                        <label>æƒ¯é‡ J: <span class="val-display" id="v_inertia">0.02</span></label>
                        <input type="range" id="inertia" min="0.005" max="0.2" step="0.001" value="0.02">
                        <label>ç”µé˜» R (Î©): <span class="val-display" id="v_res">2.5</span></label>
                        <input type="range" id="resistance" min="0.1" max="10" step="0.1" value="2.5">
                    </div>

                    <button onclick="resetSystem()" class="btn-reset">ç´§æ€¥åœæ­¢ / ç³»ç»Ÿå¤ä½</button>
                </div>

                <div class="main-content">
                    <!-- å®æ—¶ä¸“å®¶å»ºè®®é¢æ¿ -->
                    <div class="expert-advice" id="advicePanel">
                        <div class="advice-title">ğŸ’¡ ä¸“å®¶è°ƒè¯•å»ºè®®:</div>
                        <div class="advice-content" id="adviceText">
                            æ¬¢è¿æ¥åˆ°ä¼ºæœä¸“å®¶æ§åˆ¶ç³»ç»Ÿã€‚è¯·å…ˆå°è¯•è®¾ç½®ä¸€ä¸ªâ€œç›®æ ‡ä½ç½®â€ï¼Œç„¶åè§‚å¯Ÿä¸‰ç¯æ§åˆ¶å¦‚ä½•ååŒå·¥ä½œã€‚
                        </div>
                    </div>

                    <div class="motor-stage">
                        <div class="motor-shaft" id="motorShaft"></div>
                        <div class="motor-label" id="statsDisplay">POS: 0.0Â° | SPD: 0 RPM</div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-box"><canvas id="posChart"></canvas></div>
                        <div class="chart-box"><canvas id="speedChart"></canvas></div>
                        <div class="chart-box"><canvas id="currentChart"></canvas></div>
                        <div class="chart-box"><canvas id="voltageChart"></canvas></div>
                    </div>

                    <div class="tuning-steps">
                        <div style="color:#00ffcc; margin-bottom:10px; font-weight:bold;">æ ‡å‡†è°ƒè¯•æ­¥éª¤ï¼š</div>
                        <div class="step" id="step1">1. è°ƒç”µæµç¯ Kpï¼šç›´åˆ°ç”µæµå“åº”è¿…é€Ÿã€‚</div>
                        <div class="step" id="step2">2. è°ƒé€Ÿåº¦ç¯ Kiï¼šæ¶ˆé™¤å¸¦è´Ÿè½½æ—¶çš„é™å·®ã€‚</div>
                        <div class="step" id="step3">3. è°ƒä½ç½®ç¯ Kpï¼šæå‡å“åº”é€Ÿåº¦ï¼ˆè¿‡å¤§å°†æŠ–åŠ¨ï¼‰ã€‚</div>
                    </div>
                </div>

                <script type="module">
                    // ========== Tab2 åŸæœ‰è„šæœ¬ (å®Œæ•´ä¿ç•™) ==========
                    import gsap from 'https://esm.sh/gsap';
                    import Chart from 'https://esm.sh/chart.js/auto';

                    // ================= å®æ—¶è§£è¯´è¯å…¸ =================
                    const EXPERT_TIPS = {
                        targetPos: "æ”¹å˜ç›®æ ‡ä½ç½®ã€‚è§‚å¯Ÿä½ç½®æ›²çº¿ï¼ˆé’è‰²ï¼‰å¦‚ä½•è¿½éšè®¾å®šå€¼ã€‚ä¼ºæœç³»ç»Ÿçš„æ ¸å¿ƒå°±æ˜¯å®ç°é«˜ç²¾åº¦çš„ä½ç½®è¿½è¸ªã€‚",
                        loadTorque: "è´Ÿè½½è½¬çŸ©æ¨¡æ‹Ÿå¤–éƒ¨é˜»åŠ›ã€‚ä½ ä¼šçœ‹åˆ°ç”µæµç¯è¿…é€Ÿå¢åŠ ç”µæµæ¥å¯¹æŠ—é˜»åŠ›ï¼Œè¿™ä½“ç°äº†ç³»ç»Ÿçš„æŠ—å¹²æ‰°èƒ½åŠ›ã€‚",
                        kp_p: "ä½ç½®ç¯ Kpï¼šå†³å®šå“åº”å¿«æ…¢ã€‚ä¼ºæœæ ‡å‡†é€šå¸¸åªç”¨ Pã€‚å¢åŠ å®ƒèƒ½å‡å°æ»åï¼Œä½†å¦‚æœå†…ç¯ï¼ˆé€Ÿåº¦ç¯ï¼‰ä¸å¤Ÿç¨³ï¼Œä¼šå¼•èµ·å‰§çƒˆéœ‡è¡ã€‚",
                        kp_s: "é€Ÿåº¦ç¯ Kpï¼šç³»ç»Ÿçš„'åˆšæ€§'ã€‚å¢åŠ å®ƒå¯ä»¥è®©é€Ÿåº¦è·Ÿéšæ›´ç´§å¯†ï¼Œä½†è¿‡å¤§ä¼šæ”¾å¤§ç”µæœºå™ªå£°å’Œé«˜é¢‘éœ‡è¡ã€‚",
                        ki_s: "é€Ÿåº¦ç¯ Kiï¼šæ¶ˆé™¤ç¨³æ€è¯¯å·®ã€‚åœ¨æœ‰è´Ÿè½½è½¬çŸ©æ—¶ï¼Œå¿…é¡»é  Ki æ‰èƒ½è®©å®é™…é€Ÿåº¦å®Œç¾åŒ¹é…ç›®æ ‡ï¼Œå¦åˆ™ä¼šâ€˜å¸¦ä¸åŠ¨â€™ã€‚",
                        kp_c: "ç”µæµç¯ Kpï¼šè½¬çŸ©å“åº”çš„çµé­‚ã€‚å®ƒæ˜¯æœ€å†…ç¯ï¼Œå¿…é¡»ç¬¬ä¸€ä¸ªè°ƒç¨³ã€‚å®ƒå†³å®šäº†ç”µæœºäº§ç”ŸåŠ›é‡çš„é€Ÿåº¦ã€‚",
                        ki_c: "ç”µæµç¯ Kiï¼šç¡®ä¿ç”µæµï¼ˆè½¬çŸ©ï¼‰å‡†ç¡®ã€‚å› ä¸ºç”µæµç¯é¢‘ç‡æé«˜ï¼Œé€šå¸¸è®¾ç½®è¾ƒå°ï¼Œä»¥ä¿è¯ç¨³å®šæ€§ã€‚",
                        inertia: "è½¬åŠ¨æƒ¯é‡ Jï¼šç‰©ç†ç‰¹æ€§ã€‚å¢åŠ æƒ¯é‡ä¼šè®©ç”µæœºæ˜¾å¾—â€˜ç¬¨é‡â€™ã€‚ä½ éœ€è¦æ›´å¤§çš„ç”µæµç¯å¢ç›Šæ¥é©±åŠ¨å¤§æƒ¯é‡è´Ÿè½½ã€‚",
                        resistance: "ç”µæœºç”µé˜» Rï¼šå½±å“ç”µæµå“åº”é€Ÿåº¦ã€‚æ¨¡æ‹ŸçœŸå®ç”µæœºçš„å‘çƒ­å’Œé˜»æŠ—ç‰¹æ€§ã€‚"
                    };

                    // ================= ç‰©ç†å‚æ•°ä¸çŠ¶æ€ =================
                    const cfg = {
                        dt: 0.01, 
                        maxVoltage: 48, maxCurrent: 25,
                        Kt: 0.6, // è½¬çŸ©å¸¸æ•°
                        Ke: 0.5, // åç”µåŠ¨åŠ¿å¸¸æ•°
                        B: 0.02  // é˜»å°¼
                    };

                    let state = {
                        targetPos: 0, targetSpeed: 0, targetCurrent: 0,
                        pos: 0, speed: 0, current: 0, voltage: 0,
                        err_p_int: 0, err_s_int: 0, err_c_int: 0,
                        loadTorque: 0
                    };

                    const params = {
                        kp_p: 1.0, kp_s: 0.5, ki_s: 0.1, kp_c: 2.0, ki_c: 0.5,
                        J: 0.02, R: 2.5
                    };

                    // ================= åˆå§‹åŒ–å›¾è¡¨ =================
                    const createChart = (id, label, color) => {
                        return new Chart(document.getElementById(id), {
                            type: 'line',
                            data: { labels: [], datasets: [{ label, data: [], borderColor: color, borderWidth: 1.5, pointRadius: 0, fill: false }] },
                            options: { 
                                animation: false, responsive: true, maintainAspectRatio: false,
                                scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#666' } } },
                                plugins: { legend: { labels: { color: '#aaa', size: 10 } } }
                            }
                        });
                    };

                    const charts = {
                        pos: createChart('posChart', 'ä½ç½® Position (Deg)', '#00ffcc'),
                        speed: createChart('speedChart', 'é€Ÿåº¦ Speed (RPM)', '#ffff00'),
                        current: createChart('currentChart', 'ç”µæµ Current (A)', '#ff00ff'),
                        voltage: createChart('voltageChart', 'è¾“å‡ºç”µå‹ Voltage (V)', '#ffffff')
                    };

                    // ================= æ ¸å¿ƒæ§åˆ¶é€»è¾‘ (ä¸‰ç¯åµŒå¥—) =================
                    function updatePhysics() {
                        // --- 1. ä½ç½®ç¯ (Outer Loop) ---
                        // ä¼ºæœè¡Œä¸šæ ‡å‡†åªç”¨ Pï¼Œé¿å…ç§¯åˆ†å¼•èµ·çš„ç›¸ä½æ»åå’Œéœ‡è¡
                        const err_p = state.targetPos - state.pos;
                        state.targetSpeed = err_p * params.kp_p;
                        
                        // --- 2. é€Ÿåº¦ç¯ (Middle Loop) ---
                        // PI æ§åˆ¶ï¼šè´Ÿè´£æŠ—å¹²æ‰°ï¼Œå…‹æœè´Ÿè½½è½¬çŸ©æ³¢åŠ¨
                        const err_s = (state.targetSpeed * Math.PI/180 * 60) - (state.speed * Math.PI/180 * 60); 
                        state.err_s_int += err_s * cfg.dt;
                        state.targetCurrent = (err_s * params.kp_s) + (state.err_s_int * params.ki_s);
                        state.targetCurrent = Math.max(-cfg.maxCurrent, Math.min(cfg.maxCurrent, state.targetCurrent));

                        // --- 3. ç”µæµ/è½¬çŸ©ç¯ (Inner Loop) ---
                        // PI æ§åˆ¶ï¼šå“åº”æœ€å¿«çš„ä¸€ç¯ï¼Œç›´æ¥æ§åˆ¶ç”µæœºç”µç£è½¬çŸ©
                        const err_c = state.targetCurrent - state.current;
                        state.err_c_int += err_c * cfg.dt;
                        let v_out = (err_c * params.kp_c) + (state.err_c_int * params.ki_c);
                        
                        // åç”µåŠ¨åŠ¿è¡¥å¿ (Back-EMF Compensation): ç”µæœºè½¬åŠ¨äº§ç”Ÿåå‘ç”µå‹ï¼Œéœ€åœ¨é©±åŠ¨ä¸­æŠµæ¶ˆ
                        const backEMF = cfg.Ke * (state.speed * Math.PI/180);
                        state.voltage = Math.max(-cfg.maxVoltage, Math.min(cfg.maxVoltage, v_out + backEMF));

                        // --- 4. ç”µæœºç‰©ç†æ¨¡æ‹Ÿ ---
                        // ç”µæµ I = (V - e) / R
                        state.current = (state.voltage - backEMF) / params.R;
                        
                        // æœºæ¢°åŠ¨åŠ›å­¦ï¼šåŠ é€Ÿåº¦ = (ç”µç£è½¬çŸ© - è´Ÿè½½è½¬çŸ© - é˜»å°¼) / æƒ¯é‡ J
                        const torque = cfg.Kt * state.current;
                        const acceleration = (torque - state.loadTorque - cfg.B * (state.speed * Math.PI/180)) / params.J;
                        
                        const rad_s = (state.speed * Math.PI/180) + acceleration * cfg.dt;
                        state.speed = rad_s * 180 / Math.PI; 
                        state.pos += state.speed * cfg.dt;

                        // --- 5. è§†è§‰æ¸²æŸ“ ---
                        gsap.set("#motorShaft", { rotation: state.pos });
                        document.getElementById('statsDisplay').innerText = `POS: ${state.pos.toFixed(1)}Â° | SPD: ${(state.speed/6).toFixed(0)} RPM`;
                    }

                    // ================= ä¸»å¾ªç¯ =================
                    function loop() {
                        updatePhysics();
                        if (Math.floor(Date.now() / 16) % 3 === 0) updateCharts();
                        requestAnimationFrame(loop);
                    }

                    function updateCharts() {
                        Object.keys(charts).forEach(key => {
                            const chart = charts[key];
                            let val = state[key];
                            if (key === 'speed') val /= 6; 
                            
                            chart.data.labels.push("");
                            chart.data.datasets[0].data.push(val);
                            if (chart.data.labels.length > 60) {
                                chart.data.labels.shift();
                                chart.data.datasets[0].data.shift();
                            }
                            chart.update('none');
                        });
                    }

                    // ================= äº¤äº’ç»‘å®šä¸åŠ¨æ€è§£è¯´ =================
                    const bind = (id, target, isFloat = true) => {
                        const el = document.getElementById(id);
                        const disp = document.getElementById('v_' + id);
                        
                        el.addEventListener('input', (e) => {
                            const val = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value);
                            if (target in params) params[target] = val;
                            else state[target] = val;
                            disp.innerText = val.toFixed(isFloat ? 2 : 0);

                            // è§¦å‘åŠ¨æ€ä¸“å®¶æç¤º
                            const advicePanel = document.getElementById('advicePanel');
                            const adviceText = document.getElementById('adviceText');
                            adviceText.innerText = EXPERT_TIPS[id] || "æ­£åœ¨è°ƒèŠ‚ç³»ç»Ÿå‚æ•°...";
                            
                            // å¼•å¯¼æ­¥éª¤é«˜äº®
                            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                            if(id.includes('kp_c')) document.getElementById('step1').classList.add('active');
                            if(id.includes('ki_s')) document.getElementById('step2').classList.add('active');
                            if(id.includes('kp_p')) document.getElementById('step3').classList.add('active');
                        });
                    };

                    bind('targetPos', 'targetPos', false);
                    bind('loadTorque', 'loadTorque');
                    bind('kp_p', 'kp_p');
                    bind('kp_s', 'kp_s');
                    bind('ki_s', 'ki_s');
                    bind('kp_c', 'kp_c');
                    bind('ki_c', 'ki_c');
                    bind('inertia', 'J');
                    bind('resistance', 'R');

                    window.resetSystem = () => {
                        state.pos = 0; state.speed = 0; state.current = 0;
                        state.err_p_int = 0; state.err_s_int = 0; state.err_c_int = 0;
                        state.targetPos = 0;
                        document.getElementById('targetPos').value = 0;
                        document.getElementById('v_targetPos').innerText = "0";
                        document.getElementById('adviceText').innerText = "ç³»ç»Ÿå·²é‡ç½®ã€‚å»ºè®®ä»è°ƒèŠ‚ç”µæµç¯ Kp å¼€å§‹ã€‚";
                    };

                    loop();
                </script>
            </div>
        </div>
    </div>

    <!-- Tab åˆ‡æ¢æ ¸å¿ƒè„šæœ¬ -->
    <script>
        // ç»‘å®šTabåˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('.tab-nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                document.querySelectorAll('.tab-nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                
                // ç»™å½“å‰ç‚¹å‡»çš„Tabæ·»åŠ activeçŠ¶æ€
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-panel`).classList.add('active');
            });
        });
    </script>
</body>
</html>