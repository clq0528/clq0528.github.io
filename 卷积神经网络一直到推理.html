<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNN åŸç†å¯è§†åŒ– (Convolutional Neural Network)</title>
    <style>
        /* --- å…¨å±€å˜é‡ä¸åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #f0f4f8;
            --panel-bg: #ffffff;
            --primary-blue: #2980b9;
            --light-blue: #ebf5fb;
            --cell-input: #bdc3c7;
            --cell-active: #3498db;
            --cell-weight: #aed6f1;
            --scanner-border: #e67e22;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; box-sizing: border-box;
        }

        h1 { color: var(--text-dark); margin-bottom: 5px; font-size: 24px; }
        .subtitle { color: var(--text-light); font-size: 14px; margin-bottom: 20px; }

        /* --- ä¸»å¸ƒå±€å®¹å™¨ --- */
        .container {
            display: grid;
            grid-template-columns: 1fr 380px; /* å³ä¾§ç¨å¾®åŠ å®½ä»¥å®¹çº³æ—¥å¿— */
            gap: 20px;
            width: 1100px;
            max-width: 100%;
            height: 650px;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- å·¦ä¾§ï¼šå¯è§†åŒ–èˆå° (Stage) --- */
        #visual-stage {
            align-items: center; justify-content: center;
            position: relative;
            border: 1px solid #e1e8ed;
        }

        .grid-wrapper { display: grid; gap: 5px; transition: all 0.5s ease; position: relative; }
        
        .cell {
            width: 40px; height: 40px;
            background: var(--cell-input);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: rgba(255,255,255,0.8);
            transition: background-color 1.0s, transform 1.0s;
        }
        .cell.relu { background: var(--cell-active); }
        .cell.weight { background: var(--cell-weight); color: var(--text-dark); font-weight: bold; }
        
        #scanner {
            position: absolute; border: 3px solid var(--scanner-border);
            border-radius: 6px; box-shadow: 0 0 10px rgba(230, 126, 34, 0.4);
            pointer-events: none;
            transition: top 0.6s cubic-bezier(0.25, 0.8, 0.25, 1), left 0.6s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s, height 0.3s;
            z-index: 10; display: none;
        }
        .scanner-label {
            position: absolute; top: -25px; left: 0;
            background: var(--scanner-border); color: #fff;
            padding: 2px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;
        }

        #flatten-container { display: flex; gap: 10px; display: none; }
        #fc-container { display: none; flex-direction: row; align-items: center; gap: 40px; }
        .matrix-box { display: grid; grid-template-columns: repeat(3, 40px); gap: 5px; }
        .vector-col { display: flex; flex-direction: column; gap: 5px; }

        #connection-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        path {
            stroke: var(--scanner-border); stroke-width: 2; fill: none;
            stroke-dasharray: 1000; stroke-dashoffset: 1000; opacity: 0.5;
        }
        .draw-line { animation: dash 1s linear forwards; }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        #output-stage { display: none; width: 300px; flex-direction: column; gap: 15px; }
        .prob-row { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-dark); }
        .progress-bg { flex: 1; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-blue); width: 0%; transition: width 1s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .prob-val { width: 40px; text-align: right; font-weight: bold; }

        /* --- å³ä¾§ï¼šé€»è¾‘æ§åˆ¶é¢æ¿ (ä¿®æ”¹ç‰ˆ) --- */
        .controls {
            display: flex; justify-content: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0;
        }
        #start-btn {
            background: var(--primary-blue); color: #fff; border: none; padding: 8px 25px; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        #start-btn:hover:not(:disabled) { background: #1f618d; transform: translateY(-2px); }
        #start-btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* æ—¥å¿—æ»šåŠ¨å®¹å™¨ */
        .logic-box {
            background: #fafafa; border: 1px solid #e0e0e0;
            border-radius: 8px; 
            flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            padding: 10px;
            font-family: 'Consolas', monospace;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
        }

        /* å•ä¸ªæ—¥å¿—æ¡ç›® */
        .log-entry {
            background: #fff;
            border-left: 4px solid #ccc;
            padding: 12px;
            border-radius: 0 6px 6px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            opacity: 0.6; /* é»˜è®¤ç¨å¾®å˜æš—ï¼Œçªå‡ºæœ€æ–°çš„ */
        }

        /* æœ€æ–°æ¿€æ´»çš„æ—¥å¿— */
        .log-entry.active {
            border-left-color: var(--scanner-border);
            opacity: 1;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .step-tag {
            display: inline-block; background: var(--text-dark); color: #fff;
            padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-bottom: 6px;
        }
        .log-entry.active .step-tag { background: var(--primary-blue); }

        .logic-title { color: var(--text-dark); font-size: 15px; margin-bottom: 5px; font-weight: bold; }
        .log-entry.active .logic-title { color: var(--primary-blue); }

        .logic-formula { 
            font-size: 12px; color: #888; margin-bottom: 5px; font-style: italic;
            border-bottom: 1px dashed #eee; padding-bottom: 4px; display: inline-block;
        }
        .logic-desc { font-size: 13px; color: #555; line-height: 1.4; }

    </style>
</head>
<body>

    <h1>CNN ç¥ç»ç½‘ç»œåŸç†å¯è§†åŒ–</h1>
    <div class="subtitle">Forward Propagation Workflow Visualization</div>

    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="panel" id="visual-stage">
            <div id="grid-stage" class="grid-wrapper"></div>
            <div id="flatten-container"></div>
            <div id="fc-container">
                <div class="vector-col" id="fc-input-vec"></div>
                <div style="font-size:20px; color:#aaa;">Ã—</div>
                <div class="matrix-box" id="fc-weights"></div>
                <div style="font-size:20px; color:#aaa;">+ b</div>
            </div>
            <div id="output-stage">
                <div class="prob-row"><span style="width:30px">ğŸ±</span><div class="progress-bg"><div class="progress-bar" id="bar-cat"></div></div><span class="prob-val" id="val-cat">0%</span></div>
                <div class="prob-row"><span style="width:30px">ğŸ¶</span><div class="progress-bg"><div class="progress-bar" id="bar-dog"></div></div><span class="prob-val" id="val-dog">0%</span></div>
                <div class="prob-row"><span style="width:30px">ğŸš—</span><div class="progress-bg"><div class="progress-bar" id="bar-car"></div></div><span class="prob-val" id="val-car">0%</span></div>
            </div>
            <div id="scanner"><div class="scanner-label">Scanner</div></div>
            <svg id="connection-lines"></svg>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç´¯ç§¯æ—¥å¿— -->
        <div class="panel">
            <div class="controls">
                <button id="start-btn" onclick="startAnimation()">â–¶ å¼€å§‹åŠ¨ç”» (Start)</button>
            </div>
            <!-- è¿™é‡Œç°åœ¨æ˜¯ç©ºçš„ï¼Œç”±JSåŠ¨æ€å¡«å…… -->
            <div class="logic-box" id="logic-panel"></div>
        </div>
    </div>

<script>
    // --- é…ç½® ---
    const config = {
        gridSize: 5,
        cellSize: 40,
        gap: 5,
    };

    const els = {
        stage: document.getElementById('visual-stage'),
        grid: document.getElementById('grid-stage'),
        scanner: document.getElementById('scanner'),
        scannerLabel: document.querySelector('.scanner-label'),
        flattenCont: document.getElementById('flatten-container'),
        fcCont: document.getElementById('fc-container'),
        fcInput: document.getElementById('fc-input-vec'),
        fcWeights: document.getElementById('fc-weights'),
        outputStage: document.getElementById('output-stage'),
        svg: document.getElementById('connection-lines'),
        logicPanel: document.getElementById('logic-panel'),
        btn: document.getElementById('start-btn'),
        bars: { cat: document.getElementById('bar-cat'), dog: document.getElementById('bar-dog'), car: document.getElementById('bar-car') },
        vals: { cat: document.getElementById('val-cat'), dog: document.getElementById('val-dog'), car: document.getElementById('val-car') }
    };

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šè¿½åŠ æ—¥å¿—è€Œä¸æ˜¯è¦†ç›– ---
    function updateLogic(tag, title, formula, desc) {
        // 1. ç§»é™¤æ—§æ—¥å¿—çš„æ¿€æ´»çŠ¶æ€
        const oldEntries = document.querySelectorAll('.log-entry');
        oldEntries.forEach(e => e.classList.remove('active'));

        // 2. åˆ›å»ºæ–°æ—¥å¿—æ¡ç›®
        const entry = document.createElement('div');
        entry.className = 'log-entry active'; // é»˜è®¤æ–°æ¡ç›®æ¿€æ´»
        entry.innerHTML = `
            <div class="step-tag">${tag}</div>
            <div class="logic-title">${title}</div>
            <div><span class="logic-formula">${formula}</span></div>
            <div class="logic-desc">${desc}</div>
        `;

        // 3. è¿½åŠ åˆ°å®¹å™¨
        els.logicPanel.appendChild(entry);

        // 4. è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        els.logicPanel.scrollTop = els.logicPanel.scrollHeight;
    }

    // --- 1. åˆå§‹åŒ– ---
    function initScene() {
        // è§†è§‰é‡ç½®
        els.grid.style.display = 'grid';
        els.grid.style.opacity = '1';
        els.grid.style.gridTemplateColumns = `repeat(${config.gridSize}, ${config.cellSize}px)`;
        els.grid.innerHTML = '';
        els.flattenCont.style.display = 'none';
        els.fcCont.style.display = 'none';
        els.outputStage.style.display = 'none';
        els.svg.innerHTML = '';
        els.scanner.style.display = 'none';
        
        Object.values(els.bars).forEach(b => b.style.width = '0%');
        Object.values(els.vals).forEach(v => v.innerText = '0%');

        // æ¸…ç©ºæ—¥å¿—é¢æ¿
        els.logicPanel.innerHTML = '';

        // ç”Ÿæˆåˆå§‹åƒç´ 
        for (let i = 0; i < config.gridSize * config.gridSize; i++) {
            let cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerText = Math.floor(Math.random() * 9); 
            els.grid.appendChild(cell);
        }

        // æ·»åŠ ç¬¬ä¸€æ¡æ—¥å¿—
        updateLogic("Step 0", "è¾“å…¥å±‚ (Input Layer)", "Matrix: 5x5", "åŠ è½½åŸå§‹å›¾åƒæ•°æ®ã€‚æ¯ä¸ªç½‘æ ¼ä»£è¡¨ä¸€ä¸ªåƒç´ ç‚¹çš„äº®åº¦å€¼ï¼ˆ0-9ï¼‰ã€‚");
    }

    // --- åŠ¨ç”»ä¸»æµç¨‹ ---
    async function startAnimation() {
        els.btn.disabled = true;
        els.btn.innerText = "æ¼”ç¤ºè¿›è¡Œä¸­...";
        
        initScene();
        await sleep(1000);

        // å·ç§¯
        await runConvolution();

        // ReLU
        await runReLU();

        // æ± åŒ–å‡†å¤‡ + æ‰§è¡Œ
        await prepareForPooling(); 
        await runPooling();

        // å±•å¹³
        await runFlatten();

        // å…¨è¿æ¥
        await runFC();

        // Softmax
        await runSoftmax();

        els.btn.disabled = false;
        els.btn.innerText = "â†º é‡æ–°å¼€å§‹æ¼”ç¤º";
        
        // ç»“æŸæ—¥å¿—
        updateLogic("Done", "å‰å‘ä¼ æ’­ç»“æŸ", "Forward Pass Complete", "ç¥ç»ç½‘ç»œå·²å®Œæˆå¯¹å›¾åƒçš„æ¨ç†ï¼Œå¹¶è¾“å‡ºäº†åˆ†ç±»æ¦‚ç‡ã€‚");
    }

    // --- å­æµç¨‹é€»è¾‘ ---

    async function runConvolution() {
        updateLogic("Step 1", "å·ç§¯å±‚ (Convolution)", "Feature Map = Input âŠ› Kernel", 
            "3x3 å·ç§¯æ ¸åœ¨å›¾åƒä¸Šæ»‘åŠ¨æ‰«æã€‚æ¯ä¸ªä½ç½®è¿›è¡Œç‚¹ç§¯è¿ç®—ï¼ˆç›¸ä¹˜åæ±‚å’Œï¼‰ï¼Œæå–è¾¹ç¼˜ã€çº¹ç†ç­‰å±€éƒ¨ç‰¹å¾ã€‚");
        
        const kSize = 3;
        els.scanner.style.display = 'block';
        els.scannerLabel.innerText = "Kernel (3x3)";

        const steps = [
            {r:0, c:0}, {r:0, c:1}, {r:0, c:2}, // æ¼”ç¤ºç¬¬ä¸€è¡Œ
            {r:1, c:0}, {r:1, c:1}, {r:1, c:2}  // æ¼”ç¤ºç¬¬äºŒè¡Œ
        ];

        // ç¼“å­˜åç§»é‡
        const gridRect = els.grid.getBoundingClientRect();
        const stageRect = els.stage.getBoundingClientRect();
        let gridOffsetLeft = els.grid.offsetLeft;
        let gridOffsetTop = els.grid.offsetTop;

        for (let step of steps) {
            let top = step.r * (config.cellSize + config.gap);
            let left = step.c * (config.cellSize + config.gap);
            let size = (kSize * config.cellSize) + ((kSize-1) * config.gap);

            els.scanner.style.width = size + 'px';
            els.scanner.style.height = size + 'px';
            els.scanner.style.top = (gridOffsetTop + top) + 'px';
            els.scanner.style.left = (gridOffsetLeft + left) + 'px';
            
            await sleep(600);
        }
        els.scanner.style.display = 'none';
        await sleep(500);
    }

    async function runReLU() {
        updateLogic("Step 2", "æ¿€æ´»å±‚ (ReLU)", "f(x) = max(0, x)", 
            "å¼•å…¥éçº¿æ€§ç‰¹æ€§ã€‚å°†æ‰€æœ‰è´Ÿæ•°å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ä¿®æ­£ä¸º0ï¼Œä¿ç•™æ­£ç‰¹å¾ã€‚åœ¨è§†è§‰ä¸Šï¼Œæˆ‘ä»¬å°†ç‰¹å¾å›¾ç‚¹äº®ä¸ºè“è‰²ã€‚");
        
        const cells = els.grid.querySelectorAll('.cell');
        // æ¨¡æ‹Ÿé€ä¸ªæ¿€æ´»çš„è§†è§‰æ•ˆæœ
        for (let i = 0; i < cells.length; i++) {
            cells[i].classList.add('relu');
            // ç¨å¾®åœé¡¿ä¸€ä¸‹å¢åŠ åŠ¨æ„Ÿï¼Œä¸ç”¨å…¨åœ
            if(i % 5 === 0) await sleep(50);
        }
        await sleep(1000);
    }

    async function prepareForPooling() {
        updateLogic("Processing", "è¾¹ç•Œè°ƒæ•´ (Padding)", "Padding/Stride Adjust", 
            "ä¸ºäº†æ¼”ç¤ºæ± åŒ–æ•ˆæœï¼Œå°†ç‰¹å¾å›¾ç»´åº¦è§„èŒƒåŒ–ï¼ˆæ¨¡æ‹Ÿ Valid Padding åçš„è¾“å‡ºå°ºå¯¸ï¼‰ã€‚");
        
        els.grid.style.opacity = '0';
        await sleep(500);
        
        els.grid.innerHTML = '';
        els.grid.style.gridTemplateColumns = `repeat(4, ${config.cellSize}px)`;
        
        for (let i=0; i<16; i++) {
            let cell = document.createElement('div');
            cell.className = 'cell relu';
            cell.innerText = Math.floor(Math.random() * 9);
            els.grid.appendChild(cell);
        }
        
        els.grid.style.opacity = '1';
        await sleep(800);
    }

    async function runPooling() {
        updateLogic("Step 3", "æ± åŒ–å±‚ (Max Pooling)", "Output = Max(Window 2x2)", 
            "ä½¿ç”¨ 2x2 çª—å£ï¼Œæ­¥å¹…ä¸º 2 è¿›è¡Œä¸‹é‡‡æ ·ã€‚åªä¿ç•™çª—å£å†…çš„æœ€å¤§å€¼ï¼Œå‡å°‘æ•°æ®é‡å¹¶é˜²æ­¢è¿‡æ‹Ÿåˆã€‚");

        const pSize = 2;
        els.scanner.style.display = 'block';
        els.scannerLabel.innerText = "Max-Pool (2x2)";

        let gridOffsetLeft = els.grid.offsetLeft;
        let gridOffsetTop = els.grid.offsetTop;
        let size = (pSize * config.cellSize) + ((pSize-1) * config.gap);
        els.scanner.style.width = size + 'px';
        els.scanner.style.height = size + 'px';

        const positions = [{r:0, c:0}, {r:0, c:2}, {r:2, c:0}, {r:2, c:2}];

        for (let pos of positions) {
            let top = pos.r * (config.cellSize + config.gap);
            let left = pos.c * (config.cellSize + config.gap);
            els.scanner.style.top = (gridOffsetTop + top) + 'px';
            els.scanner.style.left = (gridOffsetLeft + left) + 'px';
            await sleep(800);
        }

        els.scanner.style.display = 'none';

        // å˜ä¸º 2x2
        els.grid.style.opacity = '0';
        await sleep(500);
        els.grid.style.gridTemplateColumns = `repeat(2, ${config.cellSize}px)`;
        els.grid.innerHTML = '';
        for(let i=0; i<4; i++) {
            let cell = document.createElement('div');
            cell.className = 'cell relu';
            cell.innerText = "P" + i;
            cell.style.fontWeight = "bold";
            els.grid.appendChild(cell);
        }
        els.grid.style.opacity = '1';
        await sleep(1000);
    }

    async function runFlatten() {
        updateLogic("Step 4", "å±•å¹³ (Flatten)", "2x2 Matrix â†’ 1x4 Vector", 
            "å°†äºŒç»´ç‰¹å¾å›¾æ‹‰ç›´ä¸ºä¸€ç»´å‘é‡ï¼Œä»¥ä¾¿ä¸å…¨è¿æ¥å±‚çš„ç¥ç»å…ƒè¿›è¡Œè¿æ¥ã€‚");

        els.grid.style.display = 'none';
        els.flattenCont.style.display = 'flex';
        els.flattenCont.innerHTML = '';

        for(let i=0; i<4; i++) {
            let cell = document.createElement('div');
            cell.className = 'cell relu';
            cell.innerText = "x" + i;
            cell.style.transform = 'scale(0)';
            els.flattenCont.appendChild(cell);
            await sleep(50); 
            cell.style.transform = 'scale(1)';
        }
        await sleep(1500);
    }

    async function runFC() {
        updateLogic("Step 5", "å…¨è¿æ¥å±‚ (Fully Connected)", "y = Weights Â· x + bias", 
            "æ¨¡æ‹ŸçŸ©é˜µä¹˜æ³•ã€‚è¾“å…¥å‘é‡ä¸é¢„è®­ç»ƒçš„æƒé‡çŸ©é˜µç›¸ä¹˜ï¼Œè®¡ç®—æ¯ä¸ªç±»åˆ«çš„åŸå§‹å¾—åˆ†ï¼ˆLogitsï¼‰ã€‚");

        els.flattenCont.style.display = 'none';
        els.fcCont.style.display = 'flex';
        
        // å¡«å……UI
        els.fcInput.innerHTML = '';
        for(let i=0; i<4; i++){
            let cell = document.createElement('div');
            cell.className = 'cell relu';
            cell.innerText = "x" + i;
            els.fcInput.appendChild(cell);
        }
        els.fcWeights.innerHTML = '';
        for(let i=0; i<12; i++){
            let cell = document.createElement('div');
            cell.className = 'cell weight';
            cell.innerText = "w";
            cell.style.fontSize = "10px";
            els.fcWeights.appendChild(cell);
        }

        // è¿çº¿åŠ¨ç”»
        const svgRect = els.stage.getBoundingClientRect();
        const inputRect = els.fcInput.getBoundingClientRect();
        const weightRect = els.fcWeights.getBoundingClientRect();

        const createLine = (x1, y1, x2, y2) => {
            let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M${x1} ${y1} L${x2} ${y2}`);
            path.classList.add('draw-line');
            els.svg.appendChild(path);
        };

        // ç®€å•ç¤ºæ„çº¿
        let x1 = inputRect.right - svgRect.left;
        let y1 = inputRect.top + inputRect.height/2 - svgRect.top;
        let x2 = weightRect.left - svgRect.left;
        let y2 = weightRect.top + weightRect.height/2 - svgRect.top;

        createLine(x1, y1, x2, y2);
        
        await sleep(1500);
        els.svg.innerHTML = ''; 
    }

    async function runSoftmax() {
        els.fcCont.style.display = 'none';
        els.outputStage.style.display = 'flex';
        
        updateLogic("Step 6", "è¾“å‡ºå±‚ (Softmax)", "Probability = exp(z) / Î£", 
            "å°†å¾—åˆ†è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚å¯ä»¥çœ‹åˆ° Cat çš„æ¦‚ç‡æœ€é«˜ï¼Œç¥ç»ç½‘ç»œå°†å…¶è¯†åˆ«ä¸ºçŒ«ã€‚");

        const targets = [
            { id: 'cat', val: 62 },
            { id: 'dog', val: 27 },
            { id: 'car', val: 11 }
        ];

        for (let t of targets) {
            els.bars[t.id].style.width = t.val + '%';
            setTimeout(() => {
                els.vals[t.id].innerText = t.val + '%';
            }, 600);
        }
        await sleep(1500);
    }

    // åˆå§‹åŒ–
    window.onload = initScene;

</script>
</body>
</html>