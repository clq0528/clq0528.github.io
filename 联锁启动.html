<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC é¡ºåºè”é”æ§åˆ¶ - æ•™å­¦ä¼˜åŒ–ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --plc-body: #34495e;
            --wire-off: #bdc3c7;
            --wire-on: #e74c3c;     /* é€šç”µçº¢ */
            --wire-neutral: #95a5a6;
            --logic-active: #2ecc71; /* é€»è¾‘ç»¿ */
            --highlight-bg: #fff9c4; /* æ—¥å¿—é«˜äº®èƒŒæ™¯ */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            user-select: none;
        }

        h2 { margin-bottom: 5px; color: #2c3e50; }
        .subtitle { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }

        /* ä¸»å®¹å™¨ */
        .main-stage {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            width: 1200px;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            border: 1px solid #ecf0f1;
            overflow: hidden;
        }

        .panel-header {
            background: #ecf0f1; padding: 10px 15px; font-weight: bold; color: #2c3e50;
            border-bottom: 1px solid #bdc3c7;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- å·¦ä¾§ï¼šå®ç‰©æ¥çº¿ (é‡æ„ç‰ˆ) --- */
        #phy-view { height: 600px; }

        /* PLC æœ¬ä½“ */
        .plc-unit {
            position: absolute; top: 40px; left: 150px;
            width: 200px; height: 140px;
            background: var(--plc-body);
            border-radius: 4px; color: #fff; z-index: 10;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }
        .plc-label { padding: 10px; border-bottom: 1px solid #555; font-size: 14px; font-weight: bold; }
        /* ç«¯å­æ’å¸ƒå±€ï¼šå·¦å…¥å³å‡º */
        .terminals-left { position: absolute; left: -10px; top: 40px; display: flex; flex-direction: column; gap: 15px; }
        .terminals-right { position: absolute; right: -10px; top: 40px; display: flex; flex-direction: column; gap: 15px; }
        
        .screw {
            width: 20px; height: 20px; background: #95a5a6; border-radius: 50%;
            border: 1px solid #7f8c8d; position: relative;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #333; z-index: 11;
        }
        .screw::after { content:'+'; color:#555; font-size:14px; }
        .screw-label { position: absolute; font-size: 10px; color: #fff; white-space: nowrap; }
        .lbl-left { right: 25px; } .lbl-right { left: 25px; }
        
        /* æŒ‡ç¤ºç¯ */
        .led-panel {
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            background: rgba(0,0,0,0.2); border-radius: 4px; padding: 5px;
            display: flex; justify-content: space-around;
        }
        .led { width: 10px; height: 10px; background: #555; border-radius: 50%; }
        .led.on { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* æŒ‰é’®åŒºåŸŸ */
        .btn-area {
            position: absolute; bottom: 30px; left: 30px;
            display: flex; gap: 15px; z-index: 20;
        }
        .btn-wrapper { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .push-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: 3px solid #7f8c8d; cursor: pointer;
            box-shadow: 0 4px 0 #555; position: relative;
            background: #e74c3c; color: white; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .push-btn.green { background: #27ae60; }
        .push-btn:active, .push-btn.pressed { transform: translateY(4px); box-shadow: none; }
        .wire-node { width: 6px; height: 6px; background: #333; border-radius: 50%; margin-bottom: 5px; }

        /* ç”µæœºåŒºåŸŸ */
        .motor-area {
            position: absolute; bottom: 50px; right: 30px;
            display: flex; flex-direction: column; gap: 40px; z-index: 20;
        }
        .motor-box {
            width: 140px; padding: 10px; background: #ecf0f1;
            border: 2px solid #bdc3c7; border-radius: 6px; text-align: center;
            position: relative; transition: all 0.3s;
        }
        .motor-box.running { border-color: #2ecc71; background: #e8f8f5; box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        .motor-icon {
            width: 50px; height: 50px; margin: 10px auto;
            border: 4px dashed #95a5a6; border-radius: 50%;
            transition: transform 0.1s linear;
        }

        /* è¿çº¿å±‚ */
        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
        }
        path {
            fill: none; stroke: var(--wire-off); stroke-width: 2;
            stroke-linejoin: round; stroke-linecap: round; transition: stroke 0.2s;
        }
        path.hot { stroke: var(--wire-on); stroke-width: 3; }

        /* --- å³ä¾§ï¼šé€»è¾‘ä¸æ§åˆ¶ --- */
        .right-col { display: flex; flex-direction: column; height: 600px; gap: 20px; }
        
        /* æ§åˆ¶æ  */
        .control-bar {
            background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between;
        }
        .mode-switch {
            display: flex; background: #eee; padding: 3px; border-radius: 20px; cursor: pointer;
        }
        .mode-opt {
            padding: 5px 15px; border-radius: 18px; font-size: 14px; color: #666; transition: all 0.3s;
        }
        .mode-opt.active { background: #3498db; color: #fff; font-weight: bold; }
        
        .step-btn {
            background: #f39c12; color: white; border: none; padding: 8px 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold;
            display: none; box-shadow: 0 3px 0 #d35400;
        }
        .step-btn:active { transform: translateY(2px); box-shadow: none; }
        .step-btn:hover { background: #e67e22; }

        /* æ¢¯å½¢å›¾ */
        .ladder-container {
            background: #fff; flex: 1; border: 1px solid #ddd; border-radius: 8px;
            position: relative; padding: 10px 20px; font-family: 'Consolas', monospace;
        }
        .scan-line {
            position: absolute; left: 0; width: 100%; height: 4px;
            background: rgba(255, 0, 0, 0.3); pointer-events: none;
            display: none; transition: top 0.2s; z-index: 50;
        }
        .rung {
            height: 90px; border-bottom: 1px dashed #eee;
            display: flex; align-items: center; position: relative;
        }
        .rail { position: absolute; top:0; bottom:0; width:4px; background:#000; }
        .rail.left { left: 10px; } .rail.right { right: 10px; }
        
        /* æ¢¯å½¢å›¾å…ƒä»¶ */
        .sym { min-width: 60px; text-align: center; margin: 0 10px; position: relative; }
        .sym-draw { font-size: 24px; font-weight: bold; color: #333; }
        .sym-name { font-size: 12px; color: #2980b9; }
        .sym-addr { font-size: 10px; color: #7f8c8d; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); }
        .wire-h { height: 2px; background: #333; flex-grow: 1; }
        
        .logic-on .sym-draw { color: var(--logic-active); text-shadow: 0 0 5px var(--logic-active); }
        .wire-h.logic-on { background: var(--logic-active); height: 3px; box-shadow: 0 0 3px var(--logic-active); }
        
        /* è”é”æ ‡è®° */
        .interlock-box {
            border: 2px dotted #e74c3c; border-radius: 4px; padding: 5px; margin: -5px;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log-container {
            height: 200px; overflow-y: auto; background: #fafafa;
            border-top: 1px solid #eee; padding: 10px;
        }
        .log-item {
            padding: 8px 10px; margin-bottom: 5px; border-radius: 4px;
            font-size: 13px; color: #555; border-left: 3px solid transparent;
            transition: background 0.3s;
        }
        .log-item.active {
            background: var(--highlight-bg); border-left-color: #f1c40f; color: #333; font-weight: bold;
        }

        /* è™šæ‹Ÿæ‰‹æŒ‡ */
        .finger {
            position: absolute; font-size: 30px; pointer-events: none; z-index: 100;
            opacity: 0; transition: transform 0.1s;
        }
        .finger.tap { animation: tap 0.3s; }
        @keyframes tap { 0% {opacity:1; transform:scale(1.2);} 50% {transform:scale(0.9) translateY(5px);} 100%{opacity:0; transform:scale(1);} }

    </style>
</head>
<body>

    <h2>PLC é¡ºåºè”é”æ§åˆ¶ (ä¼˜åŒ–ç‰ˆ)</h2>
    <div class="subtitle">åœºæ™¯ï¼šæ²¹æ³µ (Pump) å¿…é¡»å…ˆå¯åŠ¨ï¼Œä¸»è½´ (Main) æ‰èƒ½å¯åŠ¨ã€‚æ§åˆ¶æ¨¡å¼å¯åˆ‡æ¢ã€‚</div>

    <div class="main-stage">
        <!-- å·¦ä¾§ï¼šå®ç‰©æ¥çº¿ -->
        <div class="panel" id="phy-view">
            <div class="panel-header">å®ç‰©æ¥çº¿å›¾</div>
            <div class="finger" id="finger">ğŸ‘†</div>

            <!-- SVG è¿çº¿ (å…¨æ–°è·¯å¾„ï¼Œæ— äº¤å‰é‡å ) -->
            <svg class="svg-layer">
                <!-- è¾“å…¥å…¬å…±ç«¯ (COM) ç•¥ -->
                
                <!-- æŒ‰é’® -> PLC è¾“å…¥ç«¯ (X0-X3) å·¦ä¾§å…¥ -->
                <!-- X0 --> <path id="w-x0" d="M 50 480 V 430 H 130 V 55 H 140" />
                <!-- X1 --> <path id="w-x1" d="M 105 480 V 440 H 120 V 90 H 140" />
                <!-- X2 --> <path id="w-x2" d="M 160 480 V 440 H 110 V 125 H 140" />
                <!-- X3 --> <path id="w-x3" d="M 215 480 V 430 H 100 V 160 H 140" />

                <!-- PLC è¾“å‡ºç«¯ (Y0, Y1) -> ç”µæœº å³ä¾§å‡º -->
                <!-- Y0 -> Pump --> <path id="w-y0" d="M 360 55 H 400 V 380" />
                <!-- Y1 -> Main --> <path id="w-y1" d="M 360 90 H 420 V 500" />
            </svg>

            <!-- PLC -->
            <div class="plc-unit">
                <div class="plc-label">FX3U</div>
                <!-- å·¦ä¾§ç«¯å­ (è¾“å…¥) -->
                <div class="terminals-left">
                    <div class="screw"><div class="screw-label lbl-left">X0</div></div>
                    <div class="screw"><div class="screw-label lbl-left">X1</div></div>
                    <div class="screw"><div class="screw-label lbl-left">X2</div></div>
                    <div class="screw"><div class="screw-label lbl-left">X3</div></div>
                </div>
                <!-- å³ä¾§ç«¯å­ (è¾“å‡º) -->
                <div class="terminals-right">
                    <div class="screw"><div class="screw-label lbl-right">Y0</div></div>
                    <div class="screw"><div class="screw-label lbl-right">Y1</div></div>
                </div>
                <!-- æŒ‡ç¤ºç¯ -->
                <div class="led-panel">
                    <div class="led" id="led-x0"></div>
                    <div class="led" id="led-x1"></div>
                    <div class="led" id="led-x2"></div>
                    <div class="led" id="led-x3"></div>
                    <span style="color:#aaa;">|</span>
                    <div class="led" id="led-y0"></div>
                    <div class="led" id="led-y1"></div>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="btn-area">
                <div class="btn-wrapper">
                    <div class="wire-node"></div>
                    <div class="push-btn green" id="btn-x0" onmousedown="press('x0')" onmouseup="release('x0')">X0</div>
                    <span>å¯æ³µ</span>
                </div>
                <div class="btn-wrapper">
                    <div class="wire-node"></div>
                    <div class="push-btn" id="btn-x1" onmousedown="press('x1')" onmouseup="release('x1')">X1</div>
                    <span>åœæ³µ</span>
                </div>
                <div class="btn-wrapper">
                    <div class="wire-node"></div>
                    <div class="push-btn green" id="btn-x2" onmousedown="press('x2')" onmouseup="release('x2')">X2</div>
                    <span>å¯ä¸»</span>
                </div>
                <div class="btn-wrapper">
                    <div class="wire-node"></div>
                    <div class="push-btn" id="btn-x3" onmousedown="press('x3')" onmouseup="release('x3')">X3</div>
                    <span>åœä¸»</span>
                </div>
            </div>

            <!-- ç”µæœºç»„ -->
            <div class="motor-area">
                <div class="motor-box" id="motor-y0">
                    <div style="font-weight:bold; color:#555;">æ²¹æ³µ (Pump)</div>
                    <div class="motor-icon" id="icon-y0"></div>
                    <div class="status-txt" id="txt-y0">åœæ­¢</div>
                </div>
                <div class="motor-box" id="motor-y1">
                    <div style="font-weight:bold; color:#555;">ä¸»è½´ (Main)</div>
                    <div class="motor-icon" id="icon-y1"></div>
                    <div class="status-txt" id="txt-y1">åœæ­¢</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶ä¸é€»è¾‘ -->
        <div class="right-col">
            <!-- 1. æ§åˆ¶æ¡ -->
            <div class="control-bar">
                <div class="mode-switch">
                    <div class="mode-opt active" id="mode-auto" onclick="setMode('auto')">è‡ªåŠ¨è¿è¡Œ (Auto)</div>
                    <div class="mode-opt" id="mode-manual" onclick="setMode('manual')">å•æ­¥è°ƒè¯• (Step)</div>
                </div>
                <button class="step-btn" id="btn-next" onclick="nextStep()">æ‰§è¡Œä¸‹ä¸€æ­¥ >></button>
            </div>

            <!-- 2. æ¢¯å½¢å›¾ -->
            <div class="ladder-container">
                <div class="rail left"></div><div class="rail right"></div>
                <div class="scan-line" id="scan-line"></div>

                <!-- Rung 1 -->
                <div class="rung" id="rung-1">
                    <div class="wire-h" id="w1-1"></div>
                    <div class="sym" id="sym-x0"><div class="sym-addr">X0</div><div class="sym-draw">| |</div><div class="sym-name">å¯æ³µ</div></div>
                    <div class="wire-h" id="w1-2"></div>
                    <div class="sym" id="sym-x1"><div class="sym-addr">X1</div><div class="sym-draw">|/|</div><div class="sym-name">åœæ³µ</div></div>
                    <div class="wire-h" id="w1-3"></div>
                    <div class="sym" id="sym-y0"><div class="sym-addr">Y0</div><div class="sym-draw">( )</div><div class="sym-name">æ²¹æ³µ</div></div>
                </div>

                <!-- Rung 2 -->
                <div class="rung" id="rung-2">
                    <div class="wire-h" id="w2-1"></div>
                    <div class="sym" id="sym-x2"><div class="sym-addr">X2</div><div class="sym-draw">| |</div><div class="sym-name">å¯ä¸»</div></div>
                    <div class="wire-h" id="w2-2"></div>
                    <div class="sym interlock-box" id="sym-interlock"><div class="sym-addr">Y0</div><div class="sym-draw">| |</div><div class="sym-name">è”é”</div></div>
                    <div class="wire-h" id="w2-3"></div>
                    <div class="sym" id="sym-x3"><div class="sym-addr">X3</div><div class="sym-draw">|/|</div><div class="sym-name">åœä¸»</div></div>
                    <div class="wire-h" id="w2-4"></div>
                    <div class="sym" id="sym-y1"><div class="sym-addr">Y1</div><div class="sym-draw">( )</div><div class="sym-name">ä¸»è½´</div></div>
                </div>
            </div>

            <!-- 3. æ—¥å¿— -->
            <div class="log-container">
                <div class="log-item active" id="log-idle">ç³»ç»Ÿå¾…æœºï¼šç­‰å¾…æ“ä½œã€‚</div>
                <div class="log-item" id="log-scan">1. è¾“å…¥é‡‡æ ·ï¼šè¯»å–æŒ‰é’®çŠ¶æ€åˆ°å†…å­˜ã€‚</div>
                <div class="log-item" id="log-r1">2. é€»è¾‘è¡Œ1ï¼šåˆ¤æ–­æ²¹æ³µå¯åŠ¨æ¡ä»¶ (X0å¯ + X1æœªåœ)ã€‚</div>
                <div class="log-item" id="log-r2-block">3. é€»è¾‘è¡Œ2 (é˜»æ–­)ï¼šè”é”æœªæ»¡è¶³ (æ²¹æ³µY0æœªå¼€)ï¼Œä¸»è½´ç¦æ­¢å¯åŠ¨ã€‚</div>
                <div class="log-item" id="log-r2-pass">3. é€»è¾‘è¡Œ2 (é€šè¿‡)ï¼šè”é”æ»¡è¶³ (æ²¹æ³µY0è¿è¡Œä¸­)ï¼Œå…è®¸ä¸»è½´å¯åŠ¨ã€‚</div>
                <div class="log-item" id="log-out">4. è¾“å‡ºåˆ·æ–°ï¼šé©±åŠ¨æ¥è§¦å™¨ä¸ç”µæœºåŠ¨ä½œã€‚</div>
            </div>
        </div>
    </div>

<script>
    // --- çŠ¶æ€å®šä¹‰ ---
    const plc = {
        in: { x0:0, x1:0, x2:0, x3:0 },
        mem: { y0:0, y1:0 },
        out: { y0:0, y1:0 },
        mode: 'auto', // 'auto' | 'manual'
        phase: 0 // 0:Idle, 1:Scan, 2:Rung1, 3:Rung2, 4:Output
    };

    let autoTimer = null;

    // --- æ¨¡å¼åˆ‡æ¢ ---
    function setMode(mode) {
        plc.mode = mode;
        document.getElementById('mode-auto').classList.toggle('active', mode === 'auto');
        document.getElementById('mode-manual').classList.toggle('active', mode === 'manual');
        document.getElementById('btn-next').style.display = mode === 'manual' ? 'block' : 'none';
        
        // éšè—æ‰«æçº¿
        document.getElementById('scan-line').style.display = 'none';
        
        // é‡ç½®é«˜äº®
        highlightLog('log-idle');

        if(mode === 'auto') {
            startAutoLoop();
        } else {
            stopAutoLoop();
            plc.phase = 0; // é‡ç½®åˆ°å¼€å§‹
        }
    }

    // --- äº¤äº’ ---
    function press(id) {
        plc.in[id] = 1;
        document.getElementById('btn-'+id).classList.add('pressed');
        document.getElementById('w-'+id).classList.add('hot');
        
        // è™šæ‹Ÿæ‰‹æŒ‡
        const finger = document.getElementById('finger');
        const btnRect = document.getElementById('btn-'+id).getBoundingClientRect();
        const paneRect = document.getElementById('phy-view').getBoundingClientRect();
        finger.style.left = (btnRect.left - paneRect.left + 5) + 'px';
        finger.style.top = (btnRect.top - paneRect.top + 5) + 'px';
        finger.classList.remove('tap');
        void finger.offsetWidth;
        finger.classList.add('tap');

        // å¦‚æœåœ¨è‡ªåŠ¨æ¨¡å¼ï¼Œä¸ºäº†è®©ç”¨æˆ·çœ‹æ¸…å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è®©æ—¥å¿—çŸ­æš‚å“åº”
        if(plc.mode === 'auto') {
            // è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œä¸æ˜¾ç¤ºæ‰«ææ­¥éª¤ï¼Œåªæ˜¾ç¤ºç»“æœç›¸å…³çš„æç¤º
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œè‡ªåŠ¨æ¨¡å¼ä¸‹ä¿æŒé€»è¾‘å¿«é€Ÿè¿è¡Œï¼Œæ—¥å¿—åªåœ¨çŠ¶æ€å˜è¿æ—¶æ›´æ–°
        }
    }

    function release(id) {
        plc.in[id] = 0;
        document.getElementById('btn-'+id).classList.remove('pressed');
        document.getElementById('w-'+id).classList.remove('hot');
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function executeLogic() {
        // Rung 1: Pump
        // X1 (Stop) is NC physically. Logic: if !X1_pressed
        const startPump = plc.in.x0 || plc.mem.y0;
        const stopPumpPressed = plc.in.x1 === 1; // Pressed = 1
        // Logic: Start AND NOT Stop_Pressed
        const y0_next = startPump && !stopPumpPressed;

        // Rung 2: Main
        const interlock = plc.mem.y0 === 1; // Dependency
        const startMain = plc.in.x2 || plc.mem.y1;
        const stopMainPressed = plc.in.x3 === 1;
        
        // Logic: Start AND Interlock AND NOT Stop_Pressed
        const y1_next = startMain && interlock && !stopMainPressed;

        plc.mem.y0 = y0_next ? 1 : 0;
        plc.mem.y1 = y1_next ? 1 : 0;

        return { y0: plc.mem.y0, y1: plc.mem.y1, interlock: interlock };
    }

    // --- è‡ªåŠ¨æ¨¡å¼å¾ªç¯ ---
    function startAutoLoop() {
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(() => {
            // 1. é‡‡æ ·
            // 2. é€»è¾‘
            const res = executeLogic();
            // 3. è¾“å‡º
            plc.out.y0 = res.y0;
            plc.out.y1 = res.y1;
            updateView();
            
            // è‡ªåŠ¨æ¨¡å¼ä¸‹çš„ç®€æ˜“æ—¥å¿—ï¼šåªæ˜¾ç¤ºå½“å‰çŠ¶æ€
            if(plc.out.y0 && plc.out.y1) highlightLog('log-out'); 
            else if(plc.out.y0) highlightLog('log-r2-pass');
            else highlightLog('log-idle');

        }, 100); // 100ms å¿«é€Ÿæ‰«æ
    }

    function stopAutoLoop() {
        if(autoTimer) clearInterval(autoTimer);
    }

    // --- æ‰‹åŠ¨å•æ­¥æ§åˆ¶ ---
    function nextStep() {
        plc.phase++;
        if(plc.phase > 4) plc.phase = 1;

        const scanLine = document.getElementById('scan-line');
        scanLine.style.display = 'block';

        // 1. è¾“å…¥é‡‡æ ·
        if (plc.phase === 1) {
            scanLine.style.top = '0px'; // Top of ladder
            highlightLog('log-scan');
            // è§†è§‰ä¸Šæ›´æ–°è¾“å…¥LED
            document.getElementById('led-x0').classList.toggle('on', plc.in.x0);
            document.getElementById('led-x1').classList.toggle('on', plc.in.x1);
            document.getElementById('led-x2').classList.toggle('on', plc.in.x2);
            document.getElementById('led-x3').classList.toggle('on', plc.in.x3);
        }
        
        // 2. é€»è¾‘è¡Œ 1
        else if (plc.phase === 2) {
            scanLine.style.top = '60px';
            highlightLog('log-r1');
            executeLogic(); // Update memory, not output yet
            updateLadderView(); // Show logic flow green
        }

        // 3. é€»è¾‘è¡Œ 2
        else if (plc.phase === 3) {
            scanLine.style.top = '150px';
            const res = executeLogic();
            updateLadderView();
            
            // åˆ¤æ–­æ˜¾ç¤ºå“ªä¸ªæ—¥å¿—
            const tryingStartMain = plc.in.x2 || plc.mem.y1;
            if (tryingStartMain && !res.interlock) {
                highlightLog('log-r2-block');
            } else {
                highlightLog('log-r2-pass');
            }
        }

        // 4. è¾“å‡ºåˆ·æ–°
        else if (plc.phase === 4) {
            scanLine.style.top = '220px';
            highlightLog('log-out');
            plc.out.y0 = plc.mem.y0;
            plc.out.y1 = plc.mem.y1;
            updateView(); // Update physical motors
            setTimeout(() => {
                 if(plc.mode === 'manual') scanLine.style.display = 'none';
            }, 500);
        }
    }

    // --- è§†å›¾æ›´æ–° ---
    function highlightLog(id) {
        // ç§»é™¤æ‰€æœ‰é«˜äº®
        document.querySelectorAll('.log-item').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateLadderView() {
        // Helper to set logic class
        const setLogic = (id, active) => {
            const el = document.getElementById(id);
            if(active) el.classList.add('logic-on'); else el.classList.remove('logic-on');
        };

        const startP = plc.in.x0 || plc.mem.y0;
        const notStopP = plc.in.x1 === 0;
        
        // Rung 1
        setLogic('w1-1', true);
        setLogic('sym-x0', plc.in.x0);
        setLogic('sym-x1', notStopP); // NC is closed when not pressed
        setLogic('w1-2', startP);
        setLogic('w1-3', plc.mem.y0);
        setLogic('sym-y0', plc.mem.y0);

        // Rung 2
        const startM = plc.in.x2 || plc.mem.y1;
        const interlock = plc.mem.y0 === 1;
        const notStopM = plc.in.x3 === 0;

        setLogic('w2-1', true);
        setLogic('sym-x2', plc.in.x2);
        setLogic('w2-2', startM);
        setLogic('sym-interlock', interlock);
        setLogic('w2-3', startM && interlock);
        setLogic('sym-x3', notStopM);
        setLogic('w2-4', plc.mem.y1);
        setLogic('sym-y1', plc.mem.y1);
    }

    function updateView() {
        // Physical Outputs Update
        const setMotor = (id, state) => {
            const box = document.getElementById('motor-'+id);
            const icon = document.getElementById('icon-'+id);
            const txt = document.getElementById('txt-'+id);
            const wire = document.getElementById('w-'+id);
            const led = document.getElementById('led-'+id);

            if(state) {
                box.classList.add('running');
                txt.innerText = "è¿è¡Œä¸­";
                txt.style.color = "#2ecc71";
                wire.classList.add('hot');
                led.classList.add('on');
                // ç®€å•çš„æ—‹è½¬æ¨¡æ‹Ÿ
                let r = icon.style.transform.replace(/[^0-9]/g, '') || 0;
                icon.style.transform = `rotate(${parseInt(r)+45}deg)`;
            } else {
                box.classList.remove('running');
                txt.innerText = "åœæ­¢";
                txt.style.color = "#7f8c8d";
                wire.classList.remove('hot');
                led.classList.remove('on');
            }
        };

        setMotor('y0', plc.out.y0);
        setMotor('y1', plc.out.y1);
        
        // å¦‚æœåœ¨è‡ªåŠ¨æ¨¡å¼ï¼Œä¹Ÿè¦æ›´æ–°æ¢¯å½¢å›¾çš„è§†è§‰ï¼ˆå¯é€‰ï¼‰
        if(plc.mode === 'auto') updateLadderView();
    }

    // Init
    startAutoLoop();

</script>
</body>
</html>